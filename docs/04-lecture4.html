<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>4&nbsp; Random Variables – An Introduction to Probability</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./06-references.html" rel="next">
<link href="./03-lecture3.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./04-lecture4.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Random Variables</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">An Introduction to Probability</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-lecture1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">First probability ideas and first steps in R</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-lecture2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Probability: Basic Definitions and Rules</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-lecture3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Conditional Probability</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-lecture4.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Random Variables</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">References</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#random-variables-and-distributions" id="toc-random-variables-and-distributions" class="nav-link active" data-scroll-target="#random-variables-and-distributions"><span class="header-section-number">4.1</span> Random Variables and Distributions</a></li>
  <li><a href="#probability-distributions-and-cumulative-probability-distributions" id="toc-probability-distributions-and-cumulative-probability-distributions" class="nav-link" data-scroll-target="#probability-distributions-and-cumulative-probability-distributions"><span class="header-section-number">4.2</span> Probability Distributions and Cumulative Probability Distributions</a></li>
  <li><a href="#the-binomial-distribution-a-fundamental-model-of-chance" id="toc-the-binomial-distribution-a-fundamental-model-of-chance" class="nav-link" data-scroll-target="#the-binomial-distribution-a-fundamental-model-of-chance"><span class="header-section-number">4.3</span> The Binomial Distribution: A Fundamental Model of Chance</a></li>
  <li><a href="#expected-value-variance-and-standard-error-understanding-random-variables" id="toc-expected-value-variance-and-standard-error-understanding-random-variables" class="nav-link" data-scroll-target="#expected-value-variance-and-standard-error-understanding-random-variables"><span class="header-section-number">4.4</span> Expected Value, Variance, and Standard Error: Understanding Random Variables</a></li>
  <li><a href="#extending-to-the-binomial-random-variable" id="toc-extending-to-the-binomial-random-variable" class="nav-link" data-scroll-target="#extending-to-the-binomial-random-variable"><span class="header-section-number">4.5</span> Extending to the Binomial Random Variable</a></li>
  <li><a href="#covariance" id="toc-covariance" class="nav-link" data-scroll-target="#covariance"><span class="header-section-number">4.6</span> Covariance</a></li>
  <li><a href="#variance-of-the-sum-of-random-variables" id="toc-variance-of-the-sum-of-random-variables" class="nav-link" data-scroll-target="#variance-of-the-sum-of-random-variables"><span class="header-section-number">4.7</span> Variance of the Sum of Random Variables</a></li>
  <li><a href="#working-with-the-binomial-distribution-in-r" id="toc-working-with-the-binomial-distribution-in-r" class="nav-link" data-scroll-target="#working-with-the-binomial-distribution-in-r"><span class="header-section-number">4.8</span> Working with the Binomial Distribution in R</a></li>
  <li><a href="#programming-in-r-the-binomial-lattic-model" id="toc-programming-in-r-the-binomial-lattic-model" class="nav-link" data-scroll-target="#programming-in-r-the-binomial-lattic-model"><span class="header-section-number">4.9</span> Programming in R: The binomial lattic model</a>
  <ul class="collapse">
  <li><a href="#the-binomial-lattice-model" id="toc-the-binomial-lattice-model" class="nav-link" data-scroll-target="#the-binomial-lattice-model"><span class="header-section-number">4.9.1</span> The binomial lattice model</a></li>
  <li><a href="#modelling-the-dynamics-of-the-sp500" id="toc-modelling-the-dynamics-of-the-sp500" class="nav-link" data-scroll-target="#modelling-the-dynamics-of-the-sp500"><span class="header-section-number">4.9.2</span> Modelling the Dynamics of the SP500</a></li>
  <li><a href="#the-code-building-a-binomial-lattice-plot" id="toc-the-code-building-a-binomial-lattice-plot" class="nav-link" data-scroll-target="#the-code-building-a-binomial-lattice-plot"><span class="header-section-number">4.9.3</span> The Code: Building a Binomial Lattice Plot</a></li>
  </ul></li>
  <li><a href="#programming-in-r-the-binomial-lattic-model-1" id="toc-programming-in-r-the-binomial-lattic-model-1" class="nav-link" data-scroll-target="#programming-in-r-the-binomial-lattic-model-1"><span class="header-section-number">4.10</span> Programming in R: The binomial lattic model</a>
  <ul class="collapse">
  <li><a href="#the-binomial-lattice-model-1" id="toc-the-binomial-lattice-model-1" class="nav-link" data-scroll-target="#the-binomial-lattice-model-1"><span class="header-section-number">4.10.1</span> The binomial lattice model</a></li>
  <li><a href="#modelling-the-dynamics-of-the-sp500-1" id="toc-modelling-the-dynamics-of-the-sp500-1" class="nav-link" data-scroll-target="#modelling-the-dynamics-of-the-sp500-1"><span class="header-section-number">4.10.2</span> Modelling the Dynamics of the SP500</a></li>
  <li><a href="#the-code-building-a-binomial-lattice-plot-1" id="toc-the-code-building-a-binomial-lattice-plot-1" class="nav-link" data-scroll-target="#the-code-building-a-binomial-lattice-plot-1"><span class="header-section-number">4.10.3</span> The Code: Building a Binomial Lattice Plot</a></li>
  <li><a href="#writing-modular-code-reusable-functions-for-the-binomial-lattice" id="toc-writing-modular-code-reusable-functions-for-the-binomial-lattice" class="nav-link" data-scroll-target="#writing-modular-code-reusable-functions-for-the-binomial-lattice"><span class="header-section-number">4.10.4</span> Writing Modular Code: Reusable Functions for the Binomial Lattice</a></li>
  <li><a href="#further-step-creating-a-package-for-the-binomial-lattice-model" id="toc-further-step-creating-a-package-for-the-binomial-lattice-model" class="nav-link" data-scroll-target="#further-step-creating-a-package-for-the-binomial-lattice-model"><span class="header-section-number">4.10.5</span> Further Step: Creating a Package for the Binomial Lattice Model</a></li>
  <li><a href="#using-an-llm-to-assist-in-developing-more-complex-programs" id="toc-using-an-llm-to-assist-in-developing-more-complex-programs" class="nav-link" data-scroll-target="#using-an-llm-to-assist-in-developing-more-complex-programs"><span class="header-section-number">4.10.6</span> Using an LLM to Assist in Developing More Complex Programs</a></li>
  </ul></li>
  <li><a href="#project-portfolio-simulation-and-analysis-with-discrete-random-variables" id="toc-project-portfolio-simulation-and-analysis-with-discrete-random-variables" class="nav-link" data-scroll-target="#project-portfolio-simulation-and-analysis-with-discrete-random-variables"><span class="header-section-number">4.11</span> Project: Portfolio Simulation and Analysis with Discrete Random Variables</a></li>
  <li><a href="#project-overview" id="toc-project-overview" class="nav-link" data-scroll-target="#project-overview"><span class="header-section-number">4.12</span> Project Overview</a></li>
  <li><a href="#project-objectives" id="toc-project-objectives" class="nav-link" data-scroll-target="#project-objectives"><span class="header-section-number">4.13</span> Project Objectives</a>
  <ul class="collapse">
  <li><a href="#define-the-portfolio" id="toc-define-the-portfolio" class="nav-link" data-scroll-target="#define-the-portfolio"><span class="header-section-number">4.13.1</span> Define the Portfolio</a></li>
  <li><a href="#simulate-portfolio-performance" id="toc-simulate-portfolio-performance" class="nav-link" data-scroll-target="#simulate-portfolio-performance"><span class="header-section-number">4.13.2</span> Simulate Portfolio Performance</a></li>
  <li><a href="#analyze-portfolio-performance" id="toc-analyze-portfolio-performance" class="nav-link" data-scroll-target="#analyze-portfolio-performance"><span class="header-section-number">4.13.3</span> Analyze Portfolio Performance</a></li>
  <li><a href="#visualize-results" id="toc-visualize-results" class="nav-link" data-scroll-target="#visualize-results"><span class="header-section-number">4.13.4</span> Visualize Results</a></li>
  <li><a href="#reflection-and-extensions" id="toc-reflection-and-extensions" class="nav-link" data-scroll-target="#reflection-and-extensions"><span class="header-section-number">4.13.5</span> Reflection and Extensions</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Random Variables</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Random variables are the main mathematical tool that allows us to quantify and analyze uncertainty in Finance for complex portfolios and other financial contexts like risk management. In all of these contexts random variables provide the foundation for probabilistic reasoning.</p>
<p>Throughout the previous lectures, we have encountered concepts such as conditional probabilities, dependencies, and independence. These ideas have helped us build intuition for modeling uncertainty. However, as we move into more advanced applications like portfolio risk modeling and asset price dynamics, a more explicit and formal treatment of <strong>random variables</strong> becomes unavoidable.</p>
<p>Random variables are at the core of probability theory, serving as a bridge between real-world phenomena and mathematical models. They allow us to represent uncertain outcomes numerically and provide a framework for analyzing those outcomes using tools such as <strong>expected value</strong>, <strong>variance</strong>, and <strong>covariance</strong>. These measures are indispensable for understanding and managing financial risk. Random variables play a vital role in applications like:</p>
<ul>
<li><strong>Portfolio Management</strong>: Estimating the expected return and risk of a portfolio.</li>
<li><strong>Risk Assessment</strong>: Modeling the probability of extreme events, such as market crashes.</li>
<li><strong>Asset Pricing</strong>: Understanding how prices evolve over time using models like the binomial tree.</li>
</ul>
<p>By the end of this lecture, you will:</p>
<ol type="1">
<li>Understand the definition and properties of random variables.</li>
<li>Learn how to compute and interpret expected value, variance, and covariance.</li>
<li>Apply R programming to simulate random variables and to construct a binomial tree to model asset price dynamics.</li>
</ol>
<section id="random-variables-and-distributions" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="random-variables-and-distributions"><span class="header-section-number">4.1</span> Random Variables and Distributions</h2>
<p>A <strong>random variable</strong> is a numerical outcome of a random phenomenon. Formally, a random variable is a function that assigns a real number to each outcome in the sample space of a random experiment. More explicitly:</p>
<div id="random-variable" class="callout callout-style-default callout-tip callout-titled" title="Definition: Random Variable">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Definition: Random Variable
</div>
</div>
<div class="callout-body-container callout-body">
<p>A <strong>random variable</strong> <span class="math inline">\(X\)</span> is a function <span class="math inline">\(X:\mathcal{S} \to \mathbb{R}\)</span> from the sample space (the set of all possible outcomes of the random experiment) to the real numbers.</p>
</div>
</div>
<p>A random variable is thus a <strong>function</strong> defined on the sample space of a random experiment. This formal definition allows us to generalize and analyze a wide variety of real-world scenarios. For instance:</p>
<ul>
<li>In the coin-flipping example from Lecture 2, the number of heads in 10 flips was a random variable.</li>
<li>The number of multiple brithdays in a group of <span class="math inline">\(n\)</span> people is also an example of a random variable.</li>
</ul>
<p>By explicitly recognizing these as random variables, we can now apply a systematic framework to quantify their behavior and analyze them.</p>
<p>Note that it is a widely held convention in probability theory to use capital letters such as <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> etc. as symbols of a random variable.</p>
<p>Random variables come in two varieties, depending on the properties of the sample space <span class="math inline">\({\cal S}\)</span>. If the sample space is a finite or countably finite set, the sample space is discrete and we talk of a <strong>discrete random variables</strong>.</p>
<p>Sometimes it is natural to consider continuous sample spaces. For example when we consider the return of an asset over a year or the price of a stock at a specific time. In this case we call a random variable <strong>continuous</strong>. With continuous sample spaces we will need tools from calculus. We will discuss continuous random variables in the next lecture. Here we stick with the concept of a discrete random variable.</p>
<p>In the case of a discrete sample space we can theoretically tabulate and random variable <span class="math inline">\(X\)</span> by enumerating in some order all points in the sample space and associating with each the corresponding value of <span class="math inline">\(X\)</span>.</p>
</section>
<section id="probability-distributions-and-cumulative-probability-distributions" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="probability-distributions-and-cumulative-probability-distributions"><span class="header-section-number">4.2</span> Probability Distributions and Cumulative Probability Distributions</h2>
<p>A random variable is characterized by its <strong>probability distribution</strong>, which describes how probabilities are assigned to its possible values.</p>
<div id="pmf-discrete" class="callout callout-style-default callout-tip callout-titled" title="Definition: Probability Mass Function of a Discrete Random Variable">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Definition: Probability Mass Function of a Discrete Random Variable
</div>
</div>
<div class="callout-body-container callout-body">
<p>Let <span class="math inline">\(X\)</span> be a random variable and <span class="math inline">\(x_1, x_2, ...\)</span> the values which it assumes. The aggregate of all sample points on which <span class="math inline">\(X\)</span> assumes a fixed value <span class="math inline">\(x_i\)</span> is form the event <span class="math inline">\(X = x_i\)</span>. It’s probability is denoted by <span class="math inline">\(P(X = x_i)\)</span>. The function: <span class="math display">\[\begin{equation*}
P(X = x_i) = p(x_i), \,\, i=1,2,...
\end{equation*}\]</span> is called the <strong>probability distribution</strong> of the random variable <span class="math inline">\(X\)</span>.</p>
<p>where <span class="math inline">\(p(x_i)\)</span> satisfies:</p>
<ul>
<li><span class="math inline">\(0 \leq p(x_i) \leq 1 \,\, \text{for}\,\, i = 1,2, ...\)</span></li>
<li><span class="math inline">\(\sum_{i} p(x_i) = 1\)</span>.</li>
</ul>
</div>
</div>
<p>We can visualize the probability distribution of a discrete random variable using R in a standard example: Consider a random variable <span class="math inline">\(X\)</span> that represents the outcome of rolling a fair six-sided die. The probability distribution is: <span class="math inline">\(P(X = x_i) = \frac{1}{6}, \quad i = 1, 2, 3, 4, 5, 6\)</span>.</p>
<p>This can be visualized as:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot bars</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">6</span>,<span class="dv">6</span>), <span class="at">type =</span> <span class="st">"h"</span>, </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">main =</span> <span class="st">"Probability Distribution"</span>, </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlab =</span> <span class="st">"Outcome"</span>, </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">ylab =</span> <span class="st">"Probability"</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Add blue filled points at the top of each bar</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">6</span>, <span class="dv">6</span>), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04-lecture4_files/figure-html/pmf-visualization-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This plot shows that each outcome has an equal probability of <span class="math inline">\(\frac{1}{6}\)</span> symbolized as a bar. For better readability of the graph we symbolized the function values at <span class="math inline">\(1/6\)</span> by a blue filled dot.</p>
<p>Let me discuss some common confusions that arise often with understanding the concept of a random variable.</p>
<ol type="1">
<li><p><strong>Random Variable vs.&nbsp;Outcome</strong>: A random variable is not the same as an individual outcome. It is a function that assigns values to outcomes. The confusion is partially created by the name. Maybe a better term would be a random mapping. Anyway, keep in mind that a random variable is a function defined on the sample space.</p></li>
<li><p><strong>Probability Distribution vs.&nbsp;Histogram</strong>: A probability distribution represents theoretical probabilities. Don’t mix this concept up with the concept of a histogram, known from statistics and data analysis, which shows frequencies of empirical data.</p></li>
<li><p><strong>Discrete vs.&nbsp;Continuous</strong>: Discrete variables take specific values (e.g., dice outcomes), while continuous variables can take any value in a range. Dealing with continuous variables needs specifc tools which we discuss in lecture 5.</p></li>
</ol>
<div class="callout callout-style-default callout-note callout-titled" title="Now You Try: Other Examples">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Now You Try: Other Examples
</div>
</div>
<div class="callout-body-container callout-body">
<p>Think of scenarios where you could define a discrete random variable.</p>
<p>For instance:</p>
<ul>
<li>The number of defective products in a batch of 20.</li>
<li>The number of rainy days in a week.</li>
</ul>
<p>Simulate and visualize the Probability distribution of these examples in R. You can take the visualization approach we took here. You could also try to make use of R’s <code>barplot()</code> function.</p>
</div>
</div>
<p>A related concept to the probability distribution, is the <strong>cumulative distribution function</strong> (CDF). It can also be used to describe a discrete random variable. The CDF provides the probability that the random variable <span class="math inline">\(X\)</span> takes a value less than or equal to a specific value <span class="math inline">\(x\)</span>:</p>
<div id="cdf-discrete" class="callout callout-style-default callout-tip callout-titled" title="Definition: Cumulative Distribution Function (CDF)">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Definition: Cumulative Distribution Function (CDF)
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <strong>cumulative distribution function</strong> - abbreviated CDF - shows the probability that a random variable <span class="math inline">\(X\)</span> take a value less than or equal to a given value <span class="math inline">\(x_i\)</span>. It is usually denoted as <span class="math inline">\(F(x_i) = P(X \leq x_i)\)</span> where <span class="math inline">\(F\)</span> is non-decreasing and <span class="math inline">\(0 \leq F(x_i) \leq 1\)</span> for <span class="math inline">\(i = 1,2,...\)</span></p>
</div>
</div>
<p>In the case of a discrete random variable the cumulative distribution function (CDF) is a step function, increasing by jump discontinuities. The points where the jumps occur are exactly at the values the random variable can take.</p>
<p>The CDF, <span class="math inline">\(F(x)\)</span>, can be computed in this case as:</p>
<ul>
<li><span class="math inline">\(F(1) = P(X \leq 1) = P(X = 1) = \frac{1}{6}\)</span>,</li>
<li><span class="math inline">\(F(2) = P(X \leq 2) = P(X = 1) + P(X = 2) = \frac{1}{6} + \frac{1}{6} = \frac{2}{6}\)</span>,</li>
<li><span class="math inline">\(F(3) = P(X \leq 3) = \frac{3}{6}\)</span>,</li>
<li>…</li>
<li><span class="math inline">\(F(6) = P(X \leq 6) = \frac{6}{6} = 1\)</span>.</li>
</ul>
<p>The CDF can be visualized as a step function, showing the cumulative probabilities:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>cdf <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">6</span>, <span class="dv">6</span>))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the empty plot frame</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">6</span>, <span class="fu">c</span>(<span class="dv">0</span>, cdf), <span class="at">type =</span> <span class="st">"n"</span>, </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Cumulative Distribution Function"</span>, </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Outcome"</span>, </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">"F(x)"</span>, </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">6.5</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Draw the first horizontal bar</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="fu">segments</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> <span class="st">"blue"</span>)  <span class="co"># Closed circle at (0, 0)</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="at">pch =</span> <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">cex =</span> <span class="fl">1.2</span>)  <span class="co"># Open circle at (1, 0)</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Draw the stepwise CDF</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(x) <span class="sc">-</span> <span class="dv">1</span>)) {</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Draw the horizontal bar for each step</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">segments</span>(x[i], cdf[i], x[i <span class="sc">+</span> <span class="dv">1</span>], cdf[i], <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the closed circle at the start of the segment</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(x[i], cdf[i], <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> <span class="st">"blue"</span>)  <span class="co"># Filled circle</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the open circle at the end of the segment</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(x[i <span class="sc">+</span> <span class="dv">1</span>], cdf[i], <span class="at">pch =</span> <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">cex =</span> <span class="fl">1.2</span>)  <span class="co"># Open circle</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Draw the last horizontal bar and closed circle at the end</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="fu">segments</span>(<span class="dv">6</span>, cdf[<span class="dv">6</span>], <span class="fl">6.5</span>, cdf[<span class="dv">6</span>], <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="dv">6</span>, cdf[<span class="dv">6</span>], <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> <span class="st">"blue"</span>)  <span class="co"># Closed circle at (6, 1)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04-lecture4_files/figure-html/cdf-visualization-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
A Remark on Constructing Complex Graphs in R
</div>
</div>
<div class="callout-body-container callout-body">
<p>This visualization of the cumulative distribution function (CDF) is a great example of how graphs in R can be constructed step by step using layers and overlays. Let’s break it down to understand how the graph is built:</p>
<p>We start with a blank canvas and create an empty plot frame using <code>plot()</code> with <code>type = "n"</code>. The <code>type = "n"</code> argument ensures that no points or lines are drawn initially, allowing us to control exactly what is added to the plot later. This blank canvas defines the axes, labels, and range, providing a foundation for the layers to come.</p>
<p>The first horizontal line is drawn using <code>segments()</code>, starting from <code>(0, 0)</code> to <code>(1, 0)</code>. We add a filled circle (<code>pch = 16</code>) at the start <code>(0, 0)</code> and an open circle (<code>pch = 1</code>) at the end <code>(1, 0)</code> using <code>points()</code>. This step visually initializes the CDF at the correct starting point.</p>
<p>Each step of the CDF is added one at a time using a loop. For each step: - A horizontal line is drawn to represent the constant value of the CDF over that interval. - A closed circle is placed at the beginning of the line to indicate that the value is included in the CDF at that point. - An open circle is added at the end to show that the value is not included yet, highlighting the jump discontinuity.</p>
<p>The final horizontal line is added separately to show the end of the CDF. A closed circle is placed at the end of the last step to signify the inclusion of the final value in the distribution.</p>
</div>
</div>
<p>Here are some key points to keep in mind when working with cumulative distribution functions (CDFs):</p>
<ul>
<li>The CDF gives cumulative probabilities (<span class="math inline">\(P(X \leq x)\)</span>), not individual probabilities.</li>
<li>The CDF is always non-decreasing and reaches 1 for the largest possible value of <span class="math inline">\(X\)</span>.</li>
<li>The CDF for discrete variables is a step-function with jumps at the values the random variable can take.</li>
</ul>
<p>The concepts of a probability distribution function and cumulative distribution function (CDF) can be extended to more than one random variable. When working with multiple random variables, we are often interested in their <strong>joint distribution</strong>, which describes how they behave together, and <strong>conditional distributions</strong>, which describe how one variable behaves given specific information about another. I discuss here the generalization to two random variables. All of the following discussion generalizes to more than two random variables.</p>
<div id="joint-pmf-discrete" class="callout callout-style-default callout-tip callout-titled" title="Joint Probability Distribution">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Joint Probability Distribution
</div>
</div>
<div class="callout-body-container callout-body">
<p>Consider now two discrete random variables <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> defined on the same sample space and let <span class="math inline">\(x_1,x_2, ...\)</span> and <span class="math inline">\(y_1,y_2,...\)</span> the values which they assume. Let <span class="math inline">\(f(x_i)\)</span> and <span class="math inline">\(g(y_j)\)</span> be the corresponding distribution functions. The aggregate of points in which the two condistions <span class="math inline">\(X=x_i\)</span> and <span class="math inline">\(Y=y_j\)</span> are satisfied forms an event whose probability is denoted by <span class="math display">\[P(X = x_i, Y = y_j) = p(x_i, y_j), \,\, i,j,=1,2,...\]</span> is called the <strong>joint probability distribution</strong> of <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span>. where <span class="math inline">\(p(x_i, y_j)\)</span> satisfies:</p>
<ul>
<li><span class="math inline">\(0 \leq p(x_i, y_j) \leq 1\)</span> for <span class="math inline">\(i,j = 1,2, ...\)</span>,</li>
<li><span class="math inline">\(\sum_{i,j} p(x_i, y_j) = 1\)</span> for <span class="math inline">\(i,j=1,2,...\)</span>..</li>
</ul>
</div>
</div>
<p>Let me give an example: Imagine rolling two fair six-sided dice. Let <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> represent the outcomes of the first and second dice, respectively. The joint PMF is: <span class="math display">\[P(X = x_i, Y = y_j) = \frac{1}{36}, \quad x_i, y_j = 1, 2, 3, 4, 5, 6.\]</span></p>
<p>This joint probability distribution captures the probability of every possible pair of outcomes, such as <span class="math inline">\((X = 2, Y = 5)\)</span>.</p>
<p>One visualization tool for two dimensional probability distributions the <strong>heatmap</strong>. The <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> axis of the heat map symbolized the values of <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> whereas the third dimension visualizes the probability of each pair of values <span class="math inline">\((x_i,y_j)\)</span> by a color code. So, for example when the dice are fair we should have a probability of <span class="math inline">\(1/36\)</span> for each basic outcome, so you should see only one uniform color.</p>
<p>To illustrate this visualization concept, imagine an example where the dice are biased and not fair, so the probabilities of outcomes can differ:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the outcomes and probabilities for two biased dice</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>outcomes <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>prob_die1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.25</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>)  <span class="co"># Probabilities for die 1</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>prob_die2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.15</span>, <span class="fl">0.2</span>, <span class="fl">0.25</span>, <span class="fl">0.2</span>, <span class="fl">0.1</span>)  <span class="co"># Probabilities for die 2</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the joint PMF as the outer product of the two probability vectors</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>joint_pmf <span class="ot">&lt;-</span> <span class="fu">outer</span>(prob_die1, prob_die2)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a heatmap using the image() function</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="fu">image</span>(</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, joint_pmf,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">colorRampPalette</span>(<span class="fu">c</span>(<span class="st">"white"</span>, <span class="st">"blue"</span>))(<span class="dv">100</span>),</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Outcome of Die 2"</span>,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Outcome of Die 1"</span>,</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">"Heatmap of Joint PMF (Two Biased Dice)"</span>,</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">axes =</span> <span class="cn">FALSE</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Add axis labels</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>, <span class="at">at =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, <span class="at">labels =</span> outcomes)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">2</span>, <span class="at">at =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, <span class="at">labels =</span> outcomes)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a color legend</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">"topright"</span>, </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend =</span> <span class="fu">round</span>(<span class="fu">seq</span>(<span class="fu">min</span>(joint_pmf), <span class="fu">max</span>(joint_pmf), <span class="at">length.out =</span> <span class="dv">5</span>), <span class="dv">3</span>),</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">fill =</span> <span class="fu">colorRampPalette</span>(<span class="fu">c</span>(<span class="st">"white"</span>, <span class="st">"blue"</span>))(<span class="dv">5</span>),</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">"Probability"</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04-lecture4_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Here you see immediately that something is fishy with the dice. Would the dice be fair there should be a uniform color all over the heatmap with a color at the value of <span class="math inline">\(1/36\)</span> or <span class="math inline">\(0.03\)</span>. Try it!</p>
<p>With this notation we can also define the notion of a conditional probability for discrete random variables.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Definition: Conditional Probability">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Definition: Conditional Probability
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <strong>conditional probability</strong> of an event <span class="math inline">\(Y=y_j\)</span>, given <span class="math inline">\(X=x_i\)</span> with <span class="math inline">\(f(x_i) &gt; 0\)</span> is defined as <span class="math display">\[
P(Y = y_j | X = x_i) = \frac{p(x_i,y_j)}{f(x_i)}
\]</span></p>
</div>
</div>
<p>In this way a number is associated with every value of <span class="math inline">\(X\)</span> and so defines a function on <span class="math inline">\(X\)</span>. This function is called</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Definition: Conditional Distribution">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Definition: Conditional Distribution
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <strong>conditional distribution</strong> of <span class="math inline">\(Y\)</span> for given <span class="math inline">\(X\)</span> and denoted by <span class="math display">\[
P(Y = y_j|X)
\]</span></p>
</div>
</div>
<p>Let’s note a few improtant points about conditional distributions:</p>
<ol type="1">
<li>In general, the conditional probability distribution of <span class="math inline">\(Y\)</span> given <span class="math inline">\(X = x_i\)</span> (denoted <span class="math inline">\(p(y_j \mid x_i)\)</span>) differs from the marginal probability distribution <span class="math inline">\(g(y_j)\)</span>. This means that knowing the value of <span class="math inline">\(X\)</span> provides information about <span class="math inline">\(Y\)</span>, which indicates stochastic dependence between <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span>. The strongest form of dependence occurs when <span class="math inline">\(Y\)</span> is a deterministic function of <span class="math inline">\(X\)</span>, i.e., <span class="math inline">\(Y = h(X)\)</span> for some function <span class="math inline">\(h\)</span>. In this case, <span class="math inline">\(X\)</span> completely determines <span class="math inline">\(Y\)</span>, and their relationship is entirely predictable.</li>
</ol>
<p>On the other hand, if the joint probability distribution <span class="math inline">\(p(x_i, y_j)\)</span> factorizes as: <span class="math display">\[
p(x_i, y_j) = f(x_i) g(y_j) \quad \text{for all pairs } (x_i, y_j),
\]</span> then <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> are <strong>independent</strong>. This implies that the occurrence of one event (e.g., <span class="math inline">\(X = x_i\)</span>) has no influence on the probability of the other (e.g., <span class="math inline">\(Y = y_j\)</span>). The joint distribution in this case takes the form of a multiplication table, where the probabilities are products of the marginal probabilities. When <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> are independent, their interaction is minimal, and no inference can be drawn about one variable from the other.</p>
<ol start="2" type="1">
<li><p>The joint distribution <span class="math inline">\(p(x_i, y_j)\)</span> uniquely determines the marginal distributions <span class="math inline">\(f(x_i)\)</span> and <span class="math inline">\(g(y_j)\)</span>, as these can be computed by summing over the appropriate dimensions: <span class="math display">\[
f(x_i) = \sum_j p(x_i, y_j), \quad g(y_j) = \sum_i p(x_i, y_j).
\]</span> However, the reverse is not true: the marginal distributions <span class="math inline">\(f(x_i)\)</span> and <span class="math inline">\(g(y_j)\)</span> alone do not determine the joint distribution <span class="math inline">\(p(x_i, y_j)\)</span>. For example, different joint distributions can have the same marginals but encode different types of dependence or independence between <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span>.</p></li>
<li><p>Note that two random variables <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> can have the same marginal distribution <span class="math inline">\(f(x_i) = g(y_j)\)</span> but may or may not be independent. For instance:</p></li>
</ol>
<ul>
<li>If <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> are independent, their joint distribution will factorize as described earlier.</li>
<li>If <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> are dependent, their joint distribution will include nontrivial interactions between the variables.</li>
</ul>
<p>At this stage it might be a good idea to recall the example on structured finance from lecture 3. The random variables hidden in this example are default indicators <span class="math inline">\(X\)</span> for bond 1 and <span class="math inline">\(Y\)</span> with <span class="math inline">\(X: \{D,N\} \mapsto \{0,1\}\)</span> and <span class="math inline">\(Y: \{D,N\} \mapsto \{0,1\}\)</span></p>
<p>In the case of <em>independence</em> we had a contingency table like this:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Marginal probabilities for B_1</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>P_N <span class="ot">&lt;-</span> <span class="fl">0.9</span>  <span class="co"># Probability that B_1 does not default</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>P_D <span class="ot">&lt;-</span> <span class="fl">0.1</span>  <span class="co"># Probability that B_1 defaults</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Conditional probabilities for B_2 given B_1</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>P_N_given_N <span class="ot">&lt;-</span> <span class="fl">0.81</span>  <span class="co"># Probability that B_2 does not default given B_1 does not default</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>P_D_given_N <span class="ot">&lt;-</span> <span class="fl">0.09</span>   <span class="co"># Probability that B_2 defaults given B_1 does not default</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>P_N_given_D <span class="ot">&lt;-</span> <span class="fl">0.09</span>    <span class="co"># Probability that B_2 does not default given B_1 defaults</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>P_D_given_D <span class="ot">&lt;-</span> <span class="fl">0.01</span>    <span class="co"># Probability that B_2 defaults given B_1 defaults</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Load necessary library</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Define marginal probabilities</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>P_N_total <span class="ot">&lt;-</span> P_N</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>P_D_total <span class="ot">&lt;-</span> P_D</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>P_N_given_total <span class="ot">&lt;-</span> <span class="fu">round</span>(P_N_given_N <span class="sc">+</span> P_D_given_N,<span class="dv">2</span>)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>P_D_given_total <span class="ot">&lt;-</span> <span class="fu">round</span>(P_N_given_D <span class="sc">+</span> P_D_given_D,<span class="dv">2</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the contingency table</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>contingency_table <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    P_D_given_D, P_D_given_N, P_D_total,    <span class="co"># Row 1: Bond 1 Default</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    P_N_given_D, P_N_given_N, P_N_total,    <span class="co"># Row 2: Bond 1 No Default</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    P_D_given_total, P_N_given_total, <span class="dv">1</span>  <span class="co"># Row 3: Column totals</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">nrow =</span> <span class="dv">3</span>,</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">byrow =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">dimnames =</span> <span class="fu">list</span>(</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"Bond 1: Default (D)"</span>, <span class="st">"Bond 1: No Default (N)"</span>, <span class="st">"Total"</span>),</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"Bond 2: Default (D)"</span>, <span class="st">"Bond 2: No Default (N)"</span>, <span class="st">"Total"</span>)</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a styled table</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>kable_output <span class="ot">&lt;-</span> knitr<span class="sc">::</span><span class="fu">kable</span>(</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>  contingency_table,</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">caption =</span> <span class="st">"Contingency Table of Joint and Marginal Probabilities: Independence"</span>,</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">format =</span> <span class="st">"html"</span>,</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">escape =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"Default (D)"</span>, <span class="st">"No Default (N)"</span>, <span class="st">"Total"</span>)</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">column_spec</span>(<span class="dv">1</span>, <span class="at">bold =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Render the table</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>kable_output</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<caption>Contingency Table of Joint and Marginal Probabilities: Independence</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Default (D)</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">No Default (N)</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Total</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Bond 1: Default (D)</td>
<td style="text-align: right;">0.01</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">0.1</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">Bond 1: No Default (N)</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">0.81</td>
<td style="text-align: right;">0.9</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Total</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">0.90</td>
<td style="text-align: right;">1.0</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>The joint probabilities in this case are just the product of the marginal probabilities and the contingency table is similar to a multiplication table.</p>
<p>In the case of <em>dependence</em> this case changes. The new contingency table now looks like this:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load necessary library</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Updated values from the table</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>P_D_given_D <span class="ot">&lt;-</span> <span class="fl">0.06</span>  <span class="co"># Probability that Y defaults given X defaults</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>P_N_given_D <span class="ot">&lt;-</span> <span class="fl">0.04</span>  <span class="co"># Probability that Y does not default given X defaults</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>P_D_given_N <span class="ot">&lt;-</span> <span class="fl">0.04</span>  <span class="co"># Probability that Y defaults given X does not default</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>P_N_given_N <span class="ot">&lt;-</span> <span class="fl">0.86</span>  <span class="co"># Probability that Y does not default given X does not default</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>P_D_total <span class="ot">&lt;-</span> <span class="fl">0.1</span>     <span class="co"># Marginal probability that Y defaults</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>P_N_total <span class="ot">&lt;-</span> <span class="fl">0.9</span>     <span class="co"># Marginal probability that Y does not default</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Define totals</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>P_D_given_total <span class="ot">&lt;-</span> P_D_given_D <span class="sc">+</span> P_D_given_N</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>P_N_given_total <span class="ot">&lt;-</span> P_N_given_D <span class="sc">+</span> P_N_given_N</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the contingency table</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>contingency_table <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    P_D_given_D, P_D_given_N, P_D_total,    <span class="co"># Row 1: X Default</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    P_N_given_D, P_N_given_N, P_N_total,    <span class="co"># Row 2: X No Default</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    P_D_given_total, P_N_given_total, <span class="dv">1</span>     <span class="co"># Row 3: Column totals</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">nrow =</span> <span class="dv">3</span>,</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">byrow =</span> <span class="cn">TRUE</span>,</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">dimnames =</span> <span class="fu">list</span>(</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"X: Default (d)"</span>, <span class="st">"X: No Default (n)"</span>, <span class="st">"Total"</span>),</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"Y: Default (d)"</span>, <span class="st">"Y: No Default (n)"</span>, <span class="st">"Total"</span>)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a styled table</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>kable_output <span class="ot">&lt;-</span> knitr<span class="sc">::</span><span class="fu">kable</span>(</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>  contingency_table,</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">caption =</span> <span class="st">"Contingency Table of Joint and Marginal Probabilities: Dependence"</span>,</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">format =</span> <span class="st">"html"</span>,</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">escape =</span> <span class="cn">FALSE</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">column_spec</span>(<span class="dv">1</span>, <span class="at">bold =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Render the table</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>kable_output</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<caption>Contingency Table of Joint and Marginal Probabilities: Dependence</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Y: Default (d)</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Y: No Default (n)</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Total</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">X: Default (d)</td>
<td style="text-align: right;">0.06</td>
<td style="text-align: right;">0.04</td>
<td style="text-align: right;">0.1</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">X: No Default (n)</td>
<td style="text-align: right;">0.04</td>
<td style="text-align: right;">0.86</td>
<td style="text-align: right;">0.9</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Total</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">0.90</td>
<td style="text-align: right;">1.0</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Note that in both cases the marginal probabilities look the same. So in the case of structured finance, a superficial analysis looking at each bond in isolation and <em>assuming</em> independence might make a fatally wrong risk asessment.</p>
<p>For instance, consider <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> that both represent the outcomes of rolling two fair dice. If <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> are independent, the joint probabilities <span class="math inline">\(p(x_i, y_j)\)</span> will simply be products of the marginal probabilities. However, if <span class="math inline">\(X = Y\)</span> (e.g., the two dice always show the same value), the joint distribution will reflect perfect dependence, and <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> are no longer independent despite having identical marginal distributions.</p>
<p>Here is a visualization of this situation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a joint PMF for dependent dice: one die matches the other</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>outcomes <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>joint_pmf <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">6</span>, <span class="dv">6</span>, <span class="dv">6</span>)  <span class="co"># Probability of matching outcomes is 1/6 for each pair</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create heatmap for the dependent joint PMF</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">image</span>(</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, joint_pmf,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">colorRampPalette</span>(<span class="fu">c</span>(<span class="st">"white"</span>, <span class="st">"blue"</span>))(<span class="dv">100</span>),</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Outcome of Die 2"</span>,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Outcome of Die 1"</span>,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">"Heatmap of Joint PMF (Dependent Dice)"</span>,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">axes =</span> <span class="cn">FALSE</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>, <span class="at">at =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, <span class="at">labels =</span> outcomes)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">2</span>, <span class="at">at =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, <span class="at">labels =</span> outcomes)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a color legend</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"topright"</span>,</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend =</span> <span class="fu">round</span>(<span class="fu">seq</span>(<span class="fu">min</span>(joint_pmf), <span class="fu">max</span>(joint_pmf), <span class="at">length.out =</span> <span class="dv">5</span>), <span class="dv">3</span>),</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">fill =</span> <span class="fu">colorRampPalette</span>(<span class="fu">c</span>(<span class="st">"white"</span>, <span class="st">"blue"</span>))(<span class="dv">5</span>),</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">"Probability"</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04-lecture4_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Keep in mind:</p>
<ul>
<li><strong>Joint Distributions</strong> describe how two random variables behave together.</li>
<li><strong>Conditional Distributions</strong> refine our understanding of one variable based on information about another.</li>
<li>Joint PMFs naturally generalize to describe both <strong>independent</strong> and <strong>dependent</strong> random variables. For dependent variables, the joint PMF captures the interaction and dependencies between the variables, often requiring <strong>conditional probabilities</strong> to explain the relationships.</li>
<li>These concepts are foundational for understanding dependencies in financial modeling, such as asset correlations or portfolio risk.</li>
</ul>
</section>
<section id="the-binomial-distribution-a-fundamental-model-of-chance" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="the-binomial-distribution-a-fundamental-model-of-chance"><span class="header-section-number">4.3</span> The Binomial Distribution: A Fundamental Model of Chance</h2>
<p>In our very first lecture we modeled the flipping of a fair coin using probability theory and R. When we modeled the coin flip with R and tried to visualize, we flipped the coin many times.</p>
<p>Say we flip the coins 10 times. How many heads do you expect to see? What’s the likelihood of getting exactly three heads? These questions, simple yet profound, are at the heart of the <strong>binomial distribution</strong> —one of the most important and versatile models of a discrete random variable.</p>
<p>The binomial distribution arises whenever we repeat a simple experiment, known as a Bernoulli trial, multiple times under the same conditions. Each trial has two possible outcomes, often labeled as “success” and “failure.” By counting the number of successes in a fixed number of trials, the binomial distribution provides a complete picture of the probabilities associated with all possible outcomes.</p>
<p>But why is the binomial distribution so crucial? For one, it is ubiquitous in applications. From predicting election outcomes to evaluating the reliability of systems and understanding financial risks, the binomial model underpins countless real-world phenomena. More importantly, it serves as a foundational tool for understanding the behavior of discrete random variables, providing a framework to compute probabilities, analyze expectations, and quantify variability.</p>
<p>In this section, we’ll explore the binomial distribution in depth. We’ll derive its probability mass function, visualize its cumulative distribution function, and compute key statistics like the mean and variance. Through this concrete example, you’ll not only solidify your understanding of random variables but also gain a versatile tool for modeling uncertainty in diverse contexts.</p>
</section>
<section id="expected-value-variance-and-standard-error-understanding-random-variables" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="expected-value-variance-and-standard-error-understanding-random-variables"><span class="header-section-number">4.4</span> Expected Value, Variance, and Standard Error: Understanding Random Variables</h2>
<p>In Lecture 1, we flipped a fair coin and asked: “What’s the likelihood of heads? How many heads would we expect in multiple flips?” Now, let’s deepen our understanding by connecting these questions to key concepts in probability: <strong>expected value</strong>, <strong>variance</strong>, and <strong>standard error</strong>.</p>
<p>Consider a single flip of a fair coin. Let’s define a random variable <span class="math inline">\(X\)</span>, where: - <span class="math inline">\(X = 1\)</span> if the coin lands heads (success), - <span class="math inline">\(X = 0\)</span> if the coin lands tails (failure).</p>
<p>This is an example of a <strong>Bernoulli random variable</strong>, the simplest discrete random variable.</p>
<div id="expected-value" class="callout callout-style-default callout-tip callout-titled" title="Definition: Expected value">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Definition: Expected value
</div>
</div>
<div class="callout-body-container callout-body">
<p>Let <span class="math inline">\(X\)</span> be a random variable assuming the values <span class="math inline">\(x_1,x_2,x_3, \dots\)</span> with probabilities <span class="math inline">\(p(x_1), p(x_2), p(x_3), \dots\)</span>. The <strong>expected value</strong> of <span class="math inline">\(X\)</span> is defined by <span class="math display">\[
\mathbb{E}[X] = \sum_{x_i} x_i \cdot p(x_i)
\]</span> provided the series converges absolutely. In this case, we say that <span class="math inline">\(X\)</span> has finite expectation. If <span class="math inline">\(\sum |x_i| p(x_i)\)</span> diverges, we say that <span class="math inline">\(X\)</span> has no finite expectation.</p>
</div>
</div>
<p>It is sometimes convenient - and we have done so repeatedly in this lecture - to interpret probabilities as limits of observable frequencies in repeated, independent random experiments.</p>
<p>This would lead to the following intuitive interpretation of expectation. Let the experiment be repeated <span class="math inline">\(n\)</span> times under identical conditions and denote by <span class="math inline">\(X_1,X_2,...,X_n\)</span> the values of <span class="math inline">\(X\)</span> that were actually observed, then for large <span class="math inline">\(n\)</span> the average of these values should be close to <span class="math inline">\(\mathbb{E}[X]\)</span>.</p>
<p>While the terms <em>mean</em>, <em>average</em> and <em>expectation</em> are synonymous, expectation is usually used in relation to random variables, whereas mean and average is used in relation to empirical data.</p>
<p>Let us compute the expected value of the Bernoulli random variable <span class="math inline">\(X\)</span>: <span class="math display">\[
\mathbb{E}[X] = 1 \cdot p + 0 \cdot (1-p) = p.
\]</span> Thus, the expected value of <span class="math inline">\(X\)</span> is <span class="math inline">\(p\)</span>. For a fair coin (<span class="math inline">\(p = 0.5\)</span>), <span class="math inline">\(\mathbb{E}[X] = 0.5\)</span>. This means that in the long run, half of the flips are expected to result in heads.</p>
<p>While the expected value gives the central tendency, the <strong>variance</strong> quantifies the spread of a random variable’s possible outcomes around its expected value.</p>
<div id="expectde-value" class="callout callout-style-default callout-tip callout-titled" title="Definition: Expected value">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Definition: Expected value
</div>
</div>
<div class="callout-body-container callout-body">
<p>Let <span class="math inline">\(X\)</span> be a random variable assuming the values <span class="math inline">\(x_1,x_2,x_3, ...\)</span> with probabilities <span class="math inline">\(p(x_1), p(x_2, p(x_3), ...\)</span>. The <strong>variance</strong> of <span class="math inline">\(X\)</span> is defined by <span class="math display">\[
\text{Var}(X) = \mathbb{E}[(X - \mathbb{E}[X])^2].
\]</span></p>
</div>
</div>
<p>For discrete random variables, this can be written as: <span class="math display">\[
\text{Var}(X) = \sum_{x_i} (x_i - \mathbb{E}[X])^2 \cdot p(x_i).
\]</span> Let’s look again at how this applies to the Bernoulli variable. For our Bernoulli random variable <span class="math inline">\(X\)</span>, substituting <span class="math inline">\(\mathbb{E}[X] = p\)</span>: <span class="math display">\[
\text{Var}(X) = (1 - p)^2 \cdot p + (0 - p)^2 \cdot (1-p) = p(1-p).
\]</span> For a fair coin (<span class="math inline">\(p = 0.5\)</span>): <span class="math display">\[
\text{Var}(X) = 0.5 \cdot 0.5 = 0.25.
\]</span></p>
<p>The <strong>standard error</strong> (SE) is the square root of the variance: <span class="math display">\[
\text{SE}(X) = \sqrt{\text{Var}(X)}.
\]</span> For our fair coin: <span class="math display">\[
\text{SE}(X) = \sqrt{0.25} = 0.5.
\]</span> The standard error is often more convenient than the variance because it is expressed in the same units as the expected value. It thus gives as a clear sense how much the random variable is spread around the mean in the units of the mean. Here is an example.</p>
<p>Suppose a stock’s daily return, <span class="math inline">\(X\)</span>, is modeled as a random variable with an expected return of 0.002 (0.2%) and a variance of <span class="math inline">\(\text{Var}(X)=0.0004\)</span> (0.04%). The variance is expressed in squared units of the return. While mathematically precise, it is not immediately interpretable because we don’t think of returns in squared terms. The standard error is 0.02 (2%) is expressed in the same units as the return. This tells us that daily returns typically deviate by about 2% from the expected return of 0.2%. This demonstrates why the standard error is often preferred when communicating uncertainty—it translates mathematical variability into a form that aligns with practical understanding.</p>
</section>
<section id="extending-to-the-binomial-random-variable" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="extending-to-the-binomial-random-variable"><span class="header-section-number">4.5</span> Extending to the Binomial Random Variable</h2>
<p>Now let’s build on this foundation. Suppose we flip the coin <span class="math inline">\(n\)</span> times and count the total number of heads. This total is a <strong>binomial random variable</strong> <span class="math inline">\(X\)</span>, with parameters: - <span class="math inline">\(n\)</span>: number of trials, - <span class="math inline">\(p\)</span>: probability of heads.</p>
<div id="binomial-dist" class="callout callout-style-default callout-tip callout-titled" title="Definition: Binomial Random Variable">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Definition: Binomial Random Variable
</div>
</div>
<div class="callout-body-container callout-body">
<p>A <strong>binomial random variable</strong> is a discrete random variable with the <span class="math inline">\(X\)</span> with probability distribution <span class="math display">\[
P(X = k) = \binom{n}{k} p^k (1-p)^{n-k}, \quad k = 0, 1, \dots, n,
\]</span> where <span class="math inline">\(\binom{n}{k}\)</span> is the number of ways to choose <span class="math inline">\(k\)</span> successes in <span class="math inline">\(n\)</span> trials.</p>
</div>
</div>
<p>The outcomes of a binomial random variable can be visualized as a <strong>binomial lattice</strong>. In the following figure <a href="#fig-coin-lattice" class="quarto-xref">Figure&nbsp;<span>4.1</span></a> we visualize the case where a coin is tossed twice.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-coin-lattice" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-coin-lattice-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figures/coin_lattice.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-coin-lattice-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.1: A binomial lattice
</figcaption>
</figure>
</div>
</div>
</div>
<p>Note that we the order of occurence of Heads and Tails does not matter. We only count how many times they occur. Therefore the sequence <code>HT</code> ends in the same node as <code>TH</code>.</p>
<p>We can compute its expected value and variance of a binomial random variable using what we’ve learned: <span class="math display">\[
\mathbb{E}[X] = n \cdot p, \quad \text{Var}(X) = n \cdot p \cdot (1-p), \quad \text{SE}(X) = \sqrt{n \cdot p \cdot (1-p)}.
\]</span> Let us briefly derive these results from the definitions:</p>
<p>To derive the <strong>expected value</strong> and <strong>variance</strong> of a binomial random variable <span class="math inline">\(X\)</span>, we use the definitions and properties of expectation and variance step-by-step.</p>
<p>A binomial random variable <span class="math inline">\(X\)</span> represents the number of successes in <span class="math inline">\(n\)</span><br>
independent trials, where each trial has:</p>
<ul>
<li>Probability of success: <span class="math inline">\(p\)</span>,</li>
<li>Probability of failure: <span class="math inline">\(1 - p\)</span>.</li>
</ul>
<p>The probability density function of <span class="math inline">\(X\)</span> is given by: <span class="math display">\[
P(X = k) = \binom{n}{k} p^k (1-p)^{n-k}, \quad k = 0, 1, 2, \dots, n.
\]</span> The expected value is defined as: <span class="math display">\[
\mathbb{E}[X] = \sum_{k=0}^n k \cdot P(X = k).
\]</span></p>
<p>Substituting: <span class="math display">\[
\mathbb{E}[X] = \sum_{k=0}^n k \cdot \binom{n}{k} p^k (1-p)^{n-k}.
\]</span> The binomial random variable <span class="math inline">\(X\)</span> can be viewed as the sum of <span class="math inline">\(n\)</span> independent Bernoulli random variables <span class="math inline">\(X_i\)</span>, where each <span class="math inline">\(X_i\)</span> is 1 for success and 0 for failure. That is: <span class="math display">\[
X = \sum_{i=1}^n X_i,
\]</span> where <span class="math inline">\(\mathbb{E}[X_i] = p\)</span>.</p>
<p>By the <strong>linearity of expectation</strong>: <span class="math display">\[
\mathbb{E}[X] = \mathbb{E}\left[\sum_{i=1}^n X_i\right] = \sum_{i=1}^n \mathbb{E}[X_i] = n \cdot p.
\]</span> The variance of <span class="math inline">\(X\)</span> is defined as: <span class="math display">\[
\text{Var}(X) = \mathbb{E}[X^2] - (\mathbb{E}[X])^2.
\]</span> We know <span class="math inline">\(X = \sum_{i=1}^n X_i\)</span>. Using the property of variance for independent random variables: <span class="math display">\[
\text{Var}(X) = \text{Var}\left(\sum_{i=1}^n X_i\right) = \sum_{i=1}^n \text{Var}(X_i).
\]</span></p>
<p>For a Bernoulli random variable <span class="math inline">\(X_i\)</span>: <span class="math display">\[
\text{Var}(X_i) = \mathbb{E}[X_i^2] - (\mathbb{E}[X_i])^2.
\]</span></p>
<p>Since <span class="math inline">\(X_i\)</span> takes values 0 and 1: <span class="math display">\[
X_i^2 = X_i, \quad \text{so } \mathbb{E}[X_i^2] = \mathbb{E}[X_i] = p.
\]</span></p>
<p>Thus: <span class="math display">\[
\text{Var}(X_i) = p - p^2 = p(1-p).
\]</span></p>
<p>Now summing over all <span class="math inline">\(n\)</span> trials: <span class="math display">\[
\text{Var}(X) = \sum_{i=1}^n \text{Var}(X_i) = n \cdot p(1-p).
\]</span></p>
<p>For <span class="math inline">\(n = 10\)</span>, <span class="math inline">\(p = 0.5\)</span>: <span class="math display">\[
\mathbb{E}[X] = 10 \cdot 0.5 = 5, \quad \text{Var}(X) = 10 \cdot 0.5 \cdot 0.5 = 2.5, \quad \text{SE}(X) = \sqrt{2.5} \approx 1.58.
\]</span></p>
<p>To solidify these concepts, let’s compute and visualize the probability distribution of a binomial random variable for <span class="math inline">\(n = 10\)</span>, <span class="math inline">\(p = 0.5\)</span>. This shows the probabilities of obtaining 0, 1, 2, …, 10 heads.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R Code to Compute and Plot PMF</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">0</span><span class="sc">:</span>n</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>pmf <span class="ot">&lt;-</span> <span class="fu">dbinom</span>(k, <span class="at">size =</span> n, <span class="at">prob =</span> p)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(k, pmf, <span class="at">type =</span> <span class="st">"h"</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">main =</span> <span class="st">"PMF of Binomial(20, 0.5)"</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Number of Heads (k)"</span>, <span class="at">ylab =</span> <span class="st">"P(X = k)"</span>, <span class="at">col =</span> <span class="st">"black"</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(k, pmf, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04-lecture4_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Key Observations</strong>: - The probability density function is symmetric around the expected value <span class="math inline">\(\mathbb{E}[X] = 10\)</span> because <span class="math inline">\(p = 0.5\)</span>. - The spread is captured by the variance and standard error, with most probabilities concentrated around the mean. The standard error is 2.2</p>
<p>The <strong>binomial distribution</strong> shows the power and versatility of the basic coin model we introduced right at the beginning of this course. It is the basic building block of this distribution and is very powerful in modeling simple experiments and deriving key properties: - <strong>Expected value</strong> provides the long-run average. - <strong>Variance</strong> and <strong>standard error</strong> measure variability. - The PMF describes the probabilities of all possible outcomes.</p>
<p>These concepts form the foundation for understanding random variables and their distributions, bridging theory and real-world applications.</p>
</section>
<section id="covariance" class="level2" data-number="4.6">
<h2 data-number="4.6" class="anchored" data-anchor-id="covariance"><span class="header-section-number">4.6</span> Covariance</h2>
<p>When we have more than one random variable we can summarize how they vary together. The concept that does this for us is <strong>covariance</strong>. Here is the definition:</p>
<div id="covariance" class="callout callout-style-default callout-tip callout-titled" title="Definition: Covariance">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Definition: Covariance
</div>
</div>
<div class="callout-body-container callout-body">
<p>The covaraince of two random variables <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> is defined by <span class="math display">\[
\text{Cov}(X,Y) = \mathbb{E}(X - \mathbb{E}[X])(Y-\mathbb{E}[Y])
\]</span> Alternatively we can write <span class="math display">\[
\text{Cov}(X,Y) = \mathbb{E}[XY] - \mathbb{E}[X]\mathbb{E}[Y]
\]</span> This definition is meaningful whenever <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> have finite variance.</p>
</div>
</div>
<p>Note the following key points about covariance:</p>
<p>-If <span class="math inline">\(\text{Cov}(X,Y)&gt;0\)</span>: <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> tend to increase together (positive relationship).</p>
<p>-If <span class="math inline">\(\text{Cov}(X,Y)&lt;0\)</span>: <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> tend to move in opposite directions (negative relationship).</p>
<p>-If <span class="math inline">\(\text{Cov}(X,Y)=0\)</span>: <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> are linearly uncorrelated, though they may still have a nonlinear relationship.</p>
<p>Covariance is often referred to as a <em>linear</em> measure of dependence. What does this mean? Covariance quantifies how the deviations of <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> from their respective means are aligned. If <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> tend to deviate in the same direction (both above or below their means), the product <span class="math inline">\((X - \mathbb{E}[X])(Y - \mathbb{E}[Y])\)</span> will typically be positive, leading to a positive covariance. Conversely, if they deviate in opposite directions, this product will typically be negative, leading to a negative covariance.</p>
<p>Covariance captures only <strong>linear relationships</strong> because it measures the degree to which <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> co-vary in a straight-line manner. If <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> are related nonlinearly (e.g., quadratic, exponential), their covariance might still be zero even though a relationship exists.</p>
<p>Here’s an example to visualize covariance using two binomially distributed random variables:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulating two binomial random variables</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="at">size =</span> <span class="dv">10</span>, <span class="at">prob =</span> <span class="fl">0.5</span>)  <span class="co"># Binomial(n=10, p=0.5)</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> X <span class="sc">+</span> <span class="fu">rbinom</span>(n, <span class="at">size =</span> <span class="dv">10</span>, <span class="at">prob =</span> <span class="fl">0.3</span>)  <span class="co"># Dependent variable</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Covariance</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>cov_xy <span class="ot">&lt;-</span> <span class="fu">cov</span>(X, Y)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatterplot with regression line</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(X, Y, <span class="at">main =</span> <span class="st">"Scatterplot of X and Y with Regression Line"</span>,</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"X (Binomial Random Variable)"</span>, <span class="at">ylab =</span> <span class="st">"Y (Dependent Variable)"</span>,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>     <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> <span class="fu">rgb</span>(<span class="fl">0.2</span>, <span class="fl">0.4</span>, <span class="fl">0.6</span>, <span class="fl">0.6</span>))</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">lm</span>(Y <span class="sc">~</span> X), <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)  <span class="co"># Add regression line</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> <span class="fu">paste</span>(<span class="st">"Covariance ="</span>, <span class="fu">round</span>(cov_xy, <span class="dv">2</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04-lecture4_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Here is what this visualization shows:</p>
<ul>
<li>The scatterplot shows the relationship between <span class="math inline">\(X\)</span> (independent binomial variable) and <span class="math inline">\(Y\)</span> (a dependent binomial variable).</li>
<li>The points are scattered around a straight line, which indicates a general linear trend. Covariance quantifies how well the variations in <span class="math inline">\(X\)</span> align with those in <span class="math inline">\(Y\)</span>.</li>
<li>The red line is added to highlight the linear relationship between the two variables.
<ul>
<li>If the covariance is large (positive or negative), the points will cluster more tightly around this line, indicating a stronger linear alignment.</li>
<li>If covariance is close to zero, the scatterplot will show a diffuse cloud of points with no clear linear trend.</li>
</ul></li>
</ul>
<p>Covariance describes only the linear component of the relationship. If <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> have a nonlinear dependency, the scatterplot may show a pattern (e.g., a curve) that the regression line and covariance fail to capture.</p>
<p>Covariance is not a good measure of dependence when the relationship between <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> is nonlinear.</p>
<p>For example, if <span class="math inline">\(Y = X^2\)</span>, <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> exhibit a strong quadratic relationship, but their covariance might be close to zero because the deviations <span class="math inline">\((X - \mathbb{E}[X])\)</span> and <span class="math inline">\((Y - \mathbb{E}[Y])\)</span> do not align linearly.</p>
<p>Here is again a visualization:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulating a stronger nonlinear relationship with binomial random variables</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="at">size =</span> <span class="dv">10</span>, <span class="at">prob =</span> <span class="fl">0.5</span>)  <span class="co"># Binomial(n=10, p=0.5)</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> (X <span class="sc">-</span> <span class="dv">5</span>)<span class="sc">^</span><span class="dv">2</span>  <span class="co"># Pronounced U-shaped relationship</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Covariance</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>cov_xy <span class="ot">&lt;-</span> <span class="fu">cov</span>(X, Y)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatterplot with LaTeX-style labels</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(X, Y, <span class="at">main =</span> <span class="fu">expression</span>(<span class="st">"Scatterplot of "</span> <span class="sc">*</span> Y <span class="sc">==</span> (X <span class="sc">-</span> <span class="dv">5</span>)<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="fu">expression</span>(X <span class="sc">~</span> <span class="st">"(Binomial Random Variable)"</span>),</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="fu">expression</span>(Y <span class="sc">~</span> <span class="st">"= (X - 5)^2"</span>),</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>     <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> <span class="fu">rgb</span>(<span class="fl">0.2</span>, <span class="fl">0.4</span>, <span class="fl">0.6</span>, <span class="fl">0.6</span>))</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">lm</span>(Y <span class="sc">~</span> X), <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)  <span class="co"># Add regression line</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> <span class="fu">paste</span>(<span class="st">"Covariance ="</span>, <span class="fu">round</span>(cov_xy, <span class="dv">2</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04-lecture4_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>To capture nonlinear dependence, measures like the <strong>mutual information</strong> or a <strong>rank correlation coefficient</strong> (e.g., Spearman’s or Kendall’s) are more appropriate.</p>
<p>By understanding the limitations of covariance, we can use it effectively for its intended purpose while recognizing when other tools are needed to describe more complex relationships.</p>
</section>
<section id="variance-of-the-sum-of-random-variables" class="level2 page-columns page-full" data-number="4.7">
<h2 data-number="4.7" class="anchored" data-anchor-id="variance-of-the-sum-of-random-variables"><span class="header-section-number">4.7</span> Variance of the Sum of Random Variables</h2>
<p>The variance of the sum of two random variables, <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span>, is a natural place where covariance arises. Let’s explore why this happens.</p>
<p>For two random variables <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span>, the variance of their sum is: <span class="math display">\[
\text{Var}(X + Y) = \text{Var}(X) + \text{Var}(Y) + 2 \cdot \text{Cov}(X, Y).
\]</span></p>
<p>Why does Covariance appear here? When adding <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span>, the variance accounts not only for the individual variances of <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span>, but also for how they interact.</p>
<p>The term <span class="math inline">\(2 \cdot \text{Cov}(X, Y)\)</span> reflects this interaction: - If <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> are positively correlated, the variability of their sum increases. - If <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> are negatively correlated, it decreases.</p>
<p>This property reflects a basic principle of insurance: Diversification reduces risk. In an insurance pool, risks (e.g., claims or losses) that are negatively correlated—or at least uncorrelated—reduce the overall variability of total claims. When risks are positively correlated (e.g., claims rise simultaneously due to shared external factors like natural disasters), the total risk increases, making diversification less effective. By managing correlation, insurers aim to stabilize payouts and maintain predictability.</p>
<p>Consider independent variables as a special case: If <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> are independent, <span class="math inline">\(\text{Cov}(X, Y) = 0\)</span>, and the formula simplifies: <span class="math display">\[
\text{Var}(X + Y) = \text{Var}(X) + \text{Var}(Y).
\]</span></p>
<p>As an example let’s go back to our previous case of tossing two coins:</p>
<p><strong>Example: Two Coin Tosses</strong>: Let <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> represent the outcomes of two coin tosses (<span class="math inline">\(X, Y = 1\)</span> for heads, <span class="math inline">\(0\)</span> for tails).</p>
<ul>
<li><strong>Case 1: Independent Tosses</strong>
<ul>
<li>Variance of each toss: <span class="math display">\[
\text{Var}(X) = p(1-p), \quad \text{Var}(Y) = p(1-p).
\]</span></li>
<li>Covariance: <span class="math display">\[
\text{Cov}(X, Y) = 0.
\]</span></li>
<li>Variance of the sum: <span class="math display">\[
\text{Var}(X + Y) = \text{Var}(X) + \text{Var}(Y) = 2p(1-p).
\]</span></li>
</ul></li>
<li><strong>Case 2: Dependent Tosses</strong>
<ul>
<li>Suppose <span class="math inline">\(P(Y = 1 \mid X = 1) = 0.7\)</span> and <span class="math inline">\(P(Y = 1 \mid X = 0) = 0.3\)</span>.</li>
<li>In this case, <span class="math inline">\(\text{Cov}(X, Y) &gt; 0\)</span>, and the variance of <span class="math inline">\(X + Y\)</span> increases due to the positive relationship between <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span>.</li>
</ul></li>
</ul>
<p>These insights can be extende to more than two random variables. For a sum of <span class="math inline">\(n\)</span> random variables <span class="math inline">\(X_1, X_2, \dots, X_n\)</span>, the variance becomes: <span class="math display">\[
\text{Var}\left(\sum_{i=1}^n X_i\right) = \sum_{i=1}^n \text{Var}(X_i) + \sum_{i \neq j} \text{Cov}(X_i, X_j).
\]</span> This shows how the covariances between pairs of random variables collectively influence the overall variance.</p>
<p>In the special case of identically independently distributed variables we get: If <span class="math inline">\(X_1, X_2, \dots, X_n\)</span> are i.i.d.: <span class="math display">\[
\text{Var}\left(\sum_{i=1}^n X_i\right) = n \cdot \text{Var}(X).
\]</span> ## Example: The CAPM formula and the Role of Covariance in comparing stocks</p>
<p>The Capital asset pricing model (CAPM) is a simple market mode, that relates individual stock returns to the market average. The CAPM formula is given by:</p>
<p><span class="math display">\[
r_{jt} = \alpha_j + \beta_j m_t + \epsilon_{jt}
\]</span></p>
<ul>
<li>The <strong>left-hand side</strong>, <span class="math inline">\(r_{jt}\)</span>, is the <strong>excess return</strong> of equity <span class="math inline">\(j\)</span> at time <span class="math inline">\(t\)</span>. This measures the return of the asset minus a measure of the risk-free rate, which represents the return on holding low-risk debt, such as a U.S. Treasury bill. For simplicity, we will omit the risk-free rate in this explanation.</li>
<li><span class="math inline">\(m_t\)</span> is the <strong>market return</strong>, which captures the aggregate return on the market at time <span class="math inline">\(t\)</span>. A common choice when looking at US data is the S&amp;P 500, which weights companies according to their market capitalization (the total value of their stock).</li>
<li><span class="math inline">\(\epsilon_{jt}\)</span> is an <strong>error term</strong>, a random variable that captures the part of the excess return not explained by the market return. It has the following properties:
<ol type="1">
<li><span class="math inline">\(\mathbb{E}[\epsilon_{jt}] = 0\)</span>, meaning it has no systematic bias.</li>
<li><span class="math inline">\(\mathbb{E}[m_t \epsilon_{jt}] = 0\)</span>, meaning it is uncorrelated with the market return.</li>
</ol></li>
</ul>
<p>The term <span class="math inline">\(\beta_j\)</span> in the CAPM formula reflects the <strong>sensitivity of the excess return of equity <span class="math inline">\(j\)</span> to the market return <span class="math inline">\(m_t\)</span></strong>. It is calculated using the <strong>covariance</strong> between the returns of the asset and the market. Specifically:</p>
<p><span class="math display">\[
\beta_j = \frac{\text{Cov}(r_j, m)}{\text{Var}(m)}
\]</span></p>
<p>Where: - <span class="math inline">\(\text{Cov}(r_j, m)\)</span> is the covariance between the excess return of equity <span class="math inline">\(j\)</span> and the market return. - <span class="math inline">\(\text{Var}(m)\)</span> is the variance of the market return.</p>
<p>This shows that <span class="math inline">\(\beta_j\)</span> represents the degree to which the return of equity <span class="math inline">\(j\)</span> moves with the market. A higher <span class="math inline">\(\beta_j\)</span> implies that the equity’s return is more sensitive to market movements, indicating a higher systematic risk.</p>
<p>The CAPM formula is built on the assumption that the excess return of an asset can be linearly decomposed into:</p>
<ul>
<li>A systematic component (<span class="math inline">\(\beta_j m_t\)</span>), which is related to market movements.</li>
<li>An idiosyncratic component (<span class="math inline">\(\epsilon_{jt}\)</span>), which is specific to the asset and uncorrelated with the market.</li>
</ul>
<p>To estimate <span class="math inline">\(\beta_j\)</span>, consider the following relationship:</p>
<p><span class="math display">\[
\mathbb{E}[r_{jt}] = \mathbb{E}[\alpha_j] + \beta_j \mathbb{E}[m_t] + \mathbb{E}[\epsilon_{jt}]
\]</span></p>
<p>Since <span class="math inline">\(\mathbb{E}[\epsilon_{jt}] = 0\)</span>, we have:</p>
<p><span class="math display">\[
\mathbb{E}[r_{jt}] = \alpha_j + \beta_j \mathbb{E}[m_t]
\]</span></p>
<p>The covariance appears when analyzing the relationship between <span class="math inline">\(r_{jt}\)</span> and <span class="math inline">\(m_t\)</span> over time. Multiplying both sides of <span class="math inline">\(r_{jt} = \alpha_j + \beta_j m_t + \epsilon_{jt}\)</span> by <span class="math inline">\(m_t\)</span> and taking expectations:</p>
<p><span class="math display">\[
\mathbb{E}[r_{jt} m_t] = \mathbb{E}[\alpha_j m_t] + \mathbb{E}[\beta_j m_t^2] + \mathbb{E}[\epsilon_{jt} m_t]
\]</span></p>
<ul>
<li>Since <span class="math inline">\(\alpha_j\)</span> is constant, <span class="math inline">\(\mathbb{E}[\alpha_j m_t] = \alpha_j \mathbb{E}[m_t]\)</span>.</li>
<li>The error term is uncorrelated with the market return, so <span class="math inline">\(\mathbb{E}[\epsilon_{jt} m_t] = 0\)</span>.</li>
</ul>
<p>This simplifies to:</p>
<p><span class="math display">\[
\mathbb{E}[r_{jt} m_t] = \alpha_j \mathbb{E}[m_t] + \beta_j \mathbb{E}[m_t^2]
\]</span></p>
<p>The covariance formula <span class="math inline">\(\text{Cov}(r_j, m)\)</span> can be used to isolate <span class="math inline">\(\beta_j\)</span>:</p>
<p><span class="math display">\[
\text{Cov}(r_j, m) = \mathbb{E}[r_{jt} m_t] - \mathbb{E}[r_{jt}]\mathbb{E}[m_t]
\]</span></p>
<p>By substituting and rearranging, we recover the key relationship for <span class="math inline">\(\beta_j\)</span>:</p>
<p><span class="math display">\[
\beta_j = \frac{\text{Cov}(r_j, m)}{\text{Var}(m)}
\]</span></p>
<p>The covariance explicitly links the asset’s return with the market return and determines the value of <span class="math inline">\(\beta_j\)</span>, capturing how much of the asset’s return can be attributed to systematic market risk. This makes covariance fundamental to the CAPM framework.</p>
<p>This simple model allows for a meaningful comparison between stocks based on their insurance properties, as well as whether the create value <span class="math inline">\(\alpha_j &gt;0\)</span>, because the stock is providing value above what the model predicts or destroy value <span class="math inline">\(\alpha_j &lt; 0\)</span> because the stock provides less value than what the model predicts based on the performance of the market.</p>
<p>Let’s compare 20 biggest stocks from the SP500. We read their data as of January 2025 using the <code>tidyquant()</code> package:</p>
<div class="cell" data-messages="false">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyquant)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the tickers for the 20 biggest stocks and the S&amp;P 500 index</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Ticker-Company Mapping:</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># NVDA - NVIDIA Corporation</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co"># AAPL - Apple Inc.</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co"># MSFT - Microsoft Corporation</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co"># AMZN - Amazon.com, Inc.</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co"># GOOGL - Alphabet Inc. (Class A)</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co"># META - Meta Platforms, Inc.</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co"># TSLA - Tesla, Inc.</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co"># UNH - UnitedHealth Group Incorporated</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co"># JNJ - Johnson &amp; Johnson</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co"># V - Visa Inc.</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co"># XOM - Exxon Mobil Corporation</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="co"># JPM - JPMorgan Chase &amp; Co.</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co"># WMT - Walmart Inc.</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co"># MA - Mastercard Incorporated</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="co"># PG - Procter &amp; Gamble Company</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="co"># HD - The Home Depot, Inc.</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="co"># BAC - Bank of America Corporation</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="co"># CVX - Chevron Corporation</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="co"># LLY - Eli Lilly and Company</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="co"># ^GSPC - S&amp;P 500 Index</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>tickers <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"NVDA"</span>, <span class="st">"AAPL"</span>, <span class="st">"MSFT"</span>, <span class="st">"AMZN"</span>, <span class="st">"GOOGL"</span>, <span class="st">"META"</span>, <span class="st">"TSLA"</span>, </span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>             <span class="st">"UNH"</span>, <span class="st">"JNJ"</span>, <span class="st">"V"</span>, <span class="st">"XOM"</span>, <span class="st">"JPM"</span>, <span class="st">"WMT"</span>, <span class="st">"MA"</span>, <span class="st">"PG"</span>, <span class="st">"HD"</span>, </span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>             <span class="st">"BAC"</span>, <span class="st">"CVX"</span>, <span class="st">"LLY"</span>)</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the S&amp;P 500 index ticker (SPY is a common ETF that tracks the index)</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>tickers <span class="ot">&lt;-</span> <span class="fu">c</span>(tickers, <span class="st">"^GSPC"</span>)</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Get historical data starting from 2015</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>price_data <span class="ot">&lt;-</span> <span class="fu">tq_get</span>(</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>  tickers, </span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">get =</span> <span class="st">"stock.prices"</span>, </span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">from =</span> <span class="st">"2015-01-01"</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s do some definitions and data filtering first:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the market ticker for the S&amp;P 500</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>market_ticker <span class="ot">&lt;-</span> <span class="st">"^GSPC"</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the market and stock data from the previously downloaded dataset</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>market_data <span class="ot">&lt;-</span> price_data[price_data<span class="sc">$</span>symbol <span class="sc">==</span> market_ticker, ]</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>stocks_data <span class="ot">&lt;-</span> price_data[price_data<span class="sc">$</span>symbol <span class="sc">!=</span> market_ticker, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here we first assign the string <code>^GSPC</code> (the Yahoo Finance ticker symbol for the S&amp;P 500 index) to the variable <code>market_ticker</code>. Then we filter rows from the <code>price_data</code> data frame where the <code>symbol</code> column matches the <code>market_ticker</code> (<code>^GSPC</code>), isolating data for the S&amp;P 500 index. The result is stored in the variable <code>market_data</code>, which contains historical price data for the market.</p>
<p>We then filter rows from the <code>price_data</code> data frame where the <code>symbol</code> column does <strong>not</strong> match <code>^GSPC</code>. The result is stored in the variable <code>stocks_data</code>, which contains historical price data for all individual stocks (excluding the S&amp;P 500 index).</p>
<p>Next we dos ome data preparation work:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure the date column is properly formatted</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>price_data<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(price_data<span class="sc">$</span>date)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate daily returns for market and stocks</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>returns_data <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="fu">split</span>(price_data, price_data<span class="sc">$</span>symbol), </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>                                      <span class="cf">function</span>(df) {</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to xts object for dailyReturn</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  xts_data <span class="ot">&lt;-</span> xts<span class="sc">::</span><span class="fu">xts</span>(df<span class="sc">$</span>adjusted, <span class="at">order.by =</span> df<span class="sc">$</span>date)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>daily_return <span class="ot">&lt;-</span> quantmod<span class="sc">::</span><span class="fu">dailyReturn</span>(xts_data, <span class="at">type =</span> <span class="st">"log"</span>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>}))</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Separate market and stock returns</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>market_returns <span class="ot">&lt;-</span> returns_data[returns_data<span class="sc">$</span>symbol <span class="sc">==</span> market_ticker, </span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"daily_return"</span>)]</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>stock_returns <span class="ot">&lt;-</span> returns_data[returns_data<span class="sc">$</span>symbol <span class="sc">!=</span> market_ticker, ]</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge market returns with each stock's returns</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>merged_data <span class="ot">&lt;-</span> <span class="fu">merge</span>(stock_returns, market_returns, <span class="at">by =</span> <span class="st">"date"</span>, </span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>                     <span class="at">suffixes =</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"_market"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s unpack this a bit:</p>
<p>First, we ensure the date column is properly formatted. We convert the <code>date</code> column in <code>price_data</code> to the <code>Date</code> format. The <code>xts</code> package (used for time-series analysis) requires its <code>order.by</code> argument to be a <code>Date</code>, <code>POSIXct</code>, or numeric value for proper time indexing.</p>
<p>Next we calculate daily returns for market and stocks. We</p>
<ol type="1">
<li><p>Split <code>price_data</code> by stock symbol. The <code>split()</code>function divides <code>price_data</code> into a list of data frames, one for each stock (or market) identified by the <code>symbol</code> column.</p></li>
<li><p>For each stock, we create an <code>xts</code> object using the <code>adjusted</code> prices (as values) and <code>date</code> (as the time index). The <code>xts</code> format is necessary for <code>dailyReturn()</code>.</p></li>
</ol>
<p>Now we are ready toc ompute the daily returns. We use the <code>dailyReturn()</code> function from the <code>quantmod</code> package to calculate log returns. Logarithmic returns are defined as: <span class="math display">\[
       r_t = \ln\left(\frac{P_t}{P_{t-1}}\right)
       \]</span> where <span class="math inline">\(P_t\)</span> is the adjusted closing price at time <span class="math inline">\(t\)</span>. The <code>dailyReturn()</code> function outputs a time series of returns, which is added as a new column (<code>daily_return</code>) to the stock’s data frame.</p>
<p>We then recombine the list of modified data frames (each containing <code>daily_return</code>) into a single data frame, <code>returns_data</code> using the <code>do.call()</code>function.</p>
<p>We now split <code>returns_data</code> into two subsets:</p>
<ul>
<li><code>market_returns</code>: Contains only the market index returns (e.g., S&amp;P 500).</li>
<li><code>stock_returns</code>: Contains the returns for all individual stocks.</li>
</ul>
<p>To Aligns the return of each stock with the corresponding market returns by their <code>date</code>. we use:</p>
<ul>
<li><code>merge()</code>:
<ul>
<li>Combines <code>stock_returns</code> and <code>market_returns</code> based on their shared <code>date</code> column.</li>
<li>Ensures that stock and market returns are matched by the same trading day.</li>
</ul></li>
<li>Suffixes:
<ul>
<li><code>suffixes = c("", "_market")</code>: Adds <code>_market</code> to columns from <code>market_returns</code> in case of naming conflicts.</li>
<li>For example: <code>daily_return</code> from <code>market_returns</code> becomes <code>daily_return_market</code>.</li>
</ul></li>
</ul>
<p>As a final output we get <code>merged_data</code> which is a data frame containing:</p>
<ul>
<li><code>symbol</code>: The stock ticker.</li>
<li><code>date</code>: The trading date.</li>
<li><code>daily_return</code>: The stock’s daily return.</li>
<li><code>daily_return_market</code>: The corresponding market’s daily return.</li>
</ul>
<p>This structure is ready for regression analysis, such as fitting the CAPM.</p>
<p>Now we fit a CAPM model to each stock:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit CAPM for each stock</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>capm_results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                <span class="fu">lapply</span>(<span class="fu">split</span>(merged_data, merged_data<span class="sc">$</span>symbol), <span class="cf">function</span>(df) {</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">lm</span>(daily_return <span class="sc">~</span> daily_return_market, <span class="at">data =</span> df)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">symbol =</span> <span class="fu">unique</span>(df<span class="sc">$</span>symbol),</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fu">coef</span>(model)[<span class="st">"(Intercept)"</span>],</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta =</span> <span class="fu">coef</span>(model)[<span class="st">"daily_return_market"</span>]</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>}))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This code fits the <strong>Capital Asset Pricing Model (CAPM)</strong> for each stock in the dataset and extracts the alpha (<span class="math inline">\(\alpha\)</span>) and beta (<span class="math inline">\(\beta\)</span>) coefficients for each stock.</p>
<p>We start by splitting the data by stock symbol, which results in a list of data frames, where each data frame contains the data for one specific stock.</p>
<p>Then we apply CAPM regression to each stock using <code>lapply()</code>:</p>
<ul>
<li><code>lm(daily_return ~ daily_return_market, data = df)</code>: Fits a linear regression model where:
<ul>
<li><code>daily_return</code> is the dependent variable (stock’s excess return).</li>
<li><code>daily_return_market</code> is the independent variable (market’s excess return).</li>
</ul></li>
<li>This corresponds to the CAPM formula: <span class="math display">\[
r_{jt} = \alpha_j + \beta_j m_t + \epsilon_{jt}
\]</span></li>
<li>The regression estimates:
<ul>
<li><span class="math inline">\(\alpha_j\)</span> (the intercept): The abnormal return of the stock independent of the market.</li>
<li><span class="math inline">\(\beta_j\)</span> (the slope): The sensitivity of the stock’s return to market movements.</li>
</ul></li>
<li>For each stock:
<ul>
<li>The regression results are used to extract <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span>.</li>
</ul></li>
</ul>
<p>Finally we create a data frame for each stock where</p>
<ul>
<li><code>unique(df$symbol)</code>: Retrieves the stock’s ticker symbol (e.g., <code>AAPL</code>, <code>GOOGL</code>).</li>
<li><code>coef(model)["(Intercept)"]</code>: Extracts <span class="math inline">\(\alpha_j\)</span> (the intercept) from the regression model.</li>
<li><code>coef(model)["daily_return_market"]</code>: Extracts <span class="math inline">\(\beta_j\)</span> (the slope) from the regression model.</li>
<li><code>data.frame(...)</code>: Creates a data frame with three columns:
<ul>
<li><code>symbol</code>: The stock ticker.</li>
<li><code>alpha</code>: The stock’s alpha (<span class="math inline">\(\alpha_j\)</span>).</li>
<li><code>beta</code>: The stock’s beta (<span class="math inline">\(\beta_j\)</span>).</li>
</ul></li>
</ul>
<p>Our final output is then a data frame with the CAPM regression results for all stocks, where each row contains:</p>
<ul>
<li><code>symbol</code>: The stock ticker.</li>
<li><code>alpha</code>: The estimated (_j) (abnormal return).</li>
<li><code>beta</code>: The estimated (_j) (market sensitivity).</li>
</ul>
<p>Now we plot these data in a two dimensional figure, which shows the stocks in a <span class="math inline">\((\beta, \alpha)\)</span> space.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot results</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  capm_results<span class="sc">$</span>beta, </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  capm_results<span class="sc">$</span>alpha,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Beta (Systematic Risk)"</span>, </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Alpha (Abnormal Return)"</span>, </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">"CAPM Alpha and Beta for S&amp;P 500 Stocks"</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,  <span class="co"># Circle symbols</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">cex =</span> <span class="dv">1</span>,   <span class="co"># Uniform size for all points</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">"blue"</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Add grid lines</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>(<span class="at">col =</span> <span class="st">"lightgray"</span>, <span class="at">lty =</span> <span class="st">"dotted"</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Add stock symbols as text labels</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  capm_results<span class="sc">$</span>beta, </span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  capm_results<span class="sc">$</span>alpha, </span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> capm_results<span class="sc">$</span>symbol, </span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">pos =</span> <span class="dv">4</span>, </span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">cex =</span> <span class="fl">0.7</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Add dashed lines for beta = 0 and alpha = 0</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">1</span>)  <span class="co"># Horizontal line at alpha = 0</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="co"># Vertical line at beta = 1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04-lecture4_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This picture immediately allows you to asess market sensitivity and arbitrage opportunities. For example over the period 2015 - 2025 bothe Amazon (AMZ) and Google (GOOGL) have similar market sensitivity (<span class="math inline">\(beta\)</span>) but Amazon has generated much more money independent of the overall market.</p>
<p>Eli Lilly and Company (LLY) an American pharmaceutical company<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> exhibits remarkably low market sensitivity while generating high <span class="math inline">\(\alpha\)</span>.</p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;Eli Lilly and Company, doing business as Lilly, is an American multinational pharmaceutical company headquartered in Indianapolis, Indiana, with offices in 18 countries. Its products are sold in approximately 125 countries. The company was founded in 1876 by Eli Lilly, a pharmaceutical chemist and Union Army veteran of the American Civil War for whom the company was later named.</p></div></div><p>Some companies like Exxon Mobil Corporation (XOM) or Chevron Corporation (CVX) appear to have destoryed value over this period, because their <span class="math inline">\(alpha\)</span> is negative.</p>
<p>Information like this can, for example, be used to to build portfolios that maximize mean returns and minimize variance in the face of uncertain future market conditions. It can also used in strategies like pairs trading, where you find two stocks with similar <span class="math inline">\(\beta\)</span> and buy higher <span class="math inline">\(\ælpha\)</span> while shortening the other.</p>
<p>This is an example where a simple property of random variables, covariance, can be used to get an intepretable model that translates raw data into information directly relevant for dcision making.</p>
</section>
<section id="working-with-the-binomial-distribution-in-r" class="level2" data-number="4.8">
<h2 data-number="4.8" class="anchored" data-anchor-id="working-with-the-binomial-distribution-in-r"><span class="header-section-number">4.8</span> Working with the Binomial Distribution in R</h2>
<p>R provides built-in functions for working with the binomial distribution. These functions follow a <strong>generic syntax</strong> that is consistent across many other distributions, making them powerful tools for statistical analysis. The key functions are:</p>
<p><strong>d is for the probability density function</strong> The probability distribution gives the probability of observing a specific number of successes in a binomial experiment: <code>dbinom(x, size, prob)</code> with</p>
<ul>
<li><code>x</code>: Number of successes.</li>
<li><code>size</code>: Number of trials (<span class="math inline">\(n\)</span>).</li>
<li><code>prob</code>: Probability of success (<span class="math inline">\(p\)</span>).</li>
</ul>
<p><strong>p is for the cumulative distribution function</strong></p>
<p>The CDF gives the probability of observing up to a certain number of successes: <code>pbinom(x, size, prob)</code> with</p>
<ul>
<li><code>x</code>: Upper limit of the number of successes.</li>
<li><code>size</code>: Number of trials (<span class="math inline">\(n\)</span>).</li>
<li><code>prob</code>: Probability of success (<span class="math inline">\(p\)</span>).</li>
</ul>
<p><strong>q is for the quantile function</strong></p>
<p>The quantile function computes the smallest number of successes for which the cumulative probability exceeds a specified value: <code>qbinom(p, size, prob)</code> with</p>
<ul>
<li><code>p</code>: Cumulative probability.</li>
<li><code>size</code>: Number of trials (<span class="math inline">\(n\)</span>).</li>
<li><code>prob</code>: Probability of success (<span class="math inline">\(p\)</span>).</li>
</ul>
<p><strong>r is for random number generation</strong></p>
<p>This function generates random samples from the binomial distribution: <code>rbinom(n, size, prob)</code> with</p>
<ul>
<li><code>n</code>: Number of random values to generate.</li>
<li><code>size</code>: Number of trials (<span class="math inline">\(n\)</span>).</li>
<li><code>prob</code>: Probability of success (<span class="math inline">\(p\)</span>).</li>
</ul>
<p>R uses a generic accross different distributions: The <code>d</code>, <code>p</code>, <code>q</code>, and <code>r</code> prefixes used in these functions are part of a generic framework in R:</p>
<ul>
<li><code>d</code> for density/PMF.</li>
<li><code>p</code> for cumulative probability (CDF).</li>
<li><code>q</code> for quantiles.</li>
<li><code>r</code> for random number generation.</li>
</ul>
<p>This structure is consistent across other distributions in R, such as the normal (dnorm, pnorm, qnorm, rnorm) or Poisson (dpois, ppois, qpois, rpois) distributions. Understanding this generic syntax simplifies working with various probability distributions.</p>
</section>
<section id="programming-in-r-the-binomial-lattic-model" class="level2" data-number="4.9">
<h2 data-number="4.9" class="anchored" data-anchor-id="programming-in-r-the-binomial-lattic-model"><span class="header-section-number">4.9</span> Programming in R: The binomial lattic model</h2>
<p>The <strong>binomial lattice model</strong> is a simple yet powerful framework for simulating asset price dynamics under uncertainty. It is widely used in financial modeling, particularly in pricing derivative securities like options, as it captures the probabilistic nature of price movements in discrete time. At each time step, an asset can either move up or down by a specified factor, creating a lattice of possible price paths. It is an excellent application case for discrete random variables but also for an introduction to writing more complex programs in R.</p>
<p>In this lecture, we will apply the binomial lattice model to simulate the dynamics of a stock index which we have now used several times in this lecture: the S&amp;P 500. This example provides a practical use case to reinforce programming concepts while exploring a key tool in financial mathematics.</p>
<p>You will learn how to:</p>
<ul>
<li>Write more complex R programs, including functions for creating and exploring the lattice.</li>
<li>Use control structures like loops (<code>for</code>, <code>while</code>, <code>repeat</code>) and conditional statements (<code>if</code>, <code>else</code>).</li>
<li>Understand and leverage R’s powerful <strong>list structure</strong> for organizing and manipulating data.</li>
<li>Apply modular programming principles to write reusable, maintainable code.</li>
</ul>
<p>By the end of this session, you’ll not only have a deeper understanding of the binomial lattice model but also the computational tools to extend this approach to more complex scenarios in financial modeling.</p>
<section id="the-binomial-lattice-model" class="level3" data-number="4.9.1">
<h3 data-number="4.9.1" class="anchored" data-anchor-id="the-binomial-lattice-model"><span class="header-section-number">4.9.1</span> The binomial lattice model</h3>
<p>To define the binomia lattice model, we need to establish a basic period length, say 1 week or one day. The model describes a situation where we know the price at the beginning of the period. The price at the beginning of the next period is one of only two possible values. Usually these possibilities are defined as multiples of the price in the previous period, a multiple <span class="math inline">\(u\)</span> (for up) and <span class="math inline">\(d\)</span> (for down). Both <span class="math inline">\(u\)</span> and <span class="math inline">\(d\)</span> are positive with <span class="math inline">\(u &gt; 1\)</span> and <span class="math inline">\(d &lt; 1\)</span>. Hence when the price at the beginning of the period is <span class="math inline">\(S\)</span>, it will be <span class="math inline">\(uS\)</span> or <span class="math inline">\(dS\)</span> at the beginning of the next period. The probabilities of these outcomes are given by <span class="math inline">\(p\)</span> and <span class="math inline">\(1-p\)</span>. This model continues for several periods.</p>
<p>By now you will recognize that the outcomes of this model will be well described by a binomial random variable. The model is equivalent to tossing a coin multiple times.</p>
<p>This binomial lattice model is fundamentally linked to the binomial distribution. Consider the price after <span class="math inline">\(n\)</span> periods. Each period represents a trial where the price either moves up (<span class="math inline">\(u\)</span>) or down (<span class="math inline">\(d\)</span>), with probabilities <span class="math inline">\(p\)</span> and <span class="math inline">\(1−p\)</span>, respectively. The total price after <span class="math inline">\(n\)</span> periods depends on the number of upward movements, denoted by <span class="math inline">\(k\)</span>, and is given by:</p>
<p><span class="math display">\[
S_n = S_0 \times  u^k \times d^{n−k}
\]</span></p>
<p>where <span class="math inline">\(k\)</span> is the number of “up” movements and <span class="math inline">\(n−k\)</span> is the number of “down” movements.</p>
<p>The distribution of <span class="math inline">\(k\)</span> follows a binomial distribution: <span class="math display">\[
P(k) = \binom{n}{k} p^k (1-p)^{n-k}, \quad k = 0, 1, 2, \dots, n
\]</span> which describes the likelihood of observing <span class="math inline">\(k\)</span> upward movements out of <span class="math inline">\(n\)</span> trials.</p>
<p>This model may seem too simplistic for describing the price dynamics of a stock index, because there are only two possible outcomes per period.</p>
<p>But when you make the connection to the binomial distribution you will realize how this restriction becomes less severe when <span class="math inline">\(\Delta t\)</span> the time steps are small: the random variable <span class="math inline">\(k\)</span>, representing the count of up movements, directly determines the possible price levels of the asset. Over many periods <span class="math inline">\(n\)</span>, this simple two-step structure generates a range of prices consistent with the binomial distribution. This relationship also explains why the model becomes increasingly flexible and realistic as the number of periods grows, enabling it to approximate more complex price dynamics.</p>
<p>Because the model is multiplicative, the price will never become negative. We can thus work with the logarithm of the price as our fundamental variable.</p>
<p>Accordinglly, we define <span class="math inline">\(\nu\)</span> as the expected annual growth rate <span class="math display">\[
\nu = \mathbb[\ln(S_T/S_0)]
\]</span> where <span class="math inline">\(S_0\)</span> is the initial stock price and <span class="math inline">\(S_T\)</span> is the price at the end of the year. Likewise we define the variance as <span class="math display">\[
\sigma^2=\text{var}[\ln(S_T/S_0)]
\]</span></p>
<p>If the period length <span class="math inline">\(\Delta t\)</span> is chosen small compared to 1, the parameters of the binomial lattice can be selected as: <span class="math display">\[\begin{eqnarray}
p &amp;=&amp; \frac{1}{2} + \frac{1}{2}\left(\frac{\nu}{\sigma}\right) \sqrt{\Delta t} \\
u &amp;=&amp; \exp(\sigma \sqrt{\Delta t}) \\
d &amp;=&amp; \exp(- \sigma \sqrt{\Delta t})
\end{eqnarray}\]</span></p>
<p>This means - for instance - that if <span class="math inline">\(\Delta t\)</span> is one week the time scaling factor would be <span class="math inline">\(\sqrt{1/52}\)</span> if it is a day it would be <span class="math inline">\(\sqrt{1/252}\)</span> assuming 252 trading days in a year.</p>
</section>
<section id="modelling-the-dynamics-of-the-sp500" class="level3" data-number="4.9.2">
<h3 data-number="4.9.2" class="anchored" data-anchor-id="modelling-the-dynamics-of-the-sp500"><span class="header-section-number">4.9.2</span> Modelling the Dynamics of the SP500</h3>
<section id="calibrating-the-model-paraemters-from-data" class="level4" data-number="4.9.2.1">
<h4 data-number="4.9.2.1" class="anchored" data-anchor-id="calibrating-the-model-paraemters-from-data"><span class="header-section-number">4.9.2.1</span> Calibrating the model paraemters from data</h4>
<p>As a use case we make a model which we calibrate to the SP500, a broad stock market index that we have used already before in our lectures. Let#s get the S&amp;P data using the <code>tidyquant</code>package:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load necessary libraries</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyquant)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We start by retrieving the data first. I use the SP500 ticker symbol <code>^GSPC</code> here. You could also use <code>SPY</code> which is an ETF tracking the SP500.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve S&amp;P 500 data (adjust ticker as needed)</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>sp500_data <span class="ot">&lt;-</span> <span class="fu">tq_get</span>(<span class="st">"SPY"</span>, <span class="at">from =</span> <span class="st">"2000-01-01"</span>, <span class="at">to =</span> <span class="st">"2025-01-01"</span>, <span class="at">get =</span> <span class="st">"stock.prices"</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract adjusted prices and dates</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>dates <span class="ot">&lt;-</span> sp500_data<span class="sc">$</span>date</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>adjusted_prices <span class="ot">&lt;-</span> sp500_data<span class="sc">$</span>adjusted</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the first trading day of each year</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>years <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">format</span>(dates, <span class="st">"%Y"</span>))  <span class="co"># Extract unique years</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>annual_indices <span class="ot">&lt;-</span> <span class="fu">sapply</span>(years, <span class="cf">function</span>(year) {</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">which</span>(<span class="fu">format</span>(dates, <span class="st">"%Y"</span>) <span class="sc">==</span> year)[<span class="dv">1</span>]  <span class="co"># Get the first trading day of the year</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract prices and dates for the first trading day of each year</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>annual_prices <span class="ot">&lt;-</span> adjusted_prices[annual_indices]</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>annual_dates <span class="ot">&lt;-</span> dates[annual_indices]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let me unpack this code-chunk a bit, especially focusing on how we use R to extract the first trading day in each year.</p>
<p>This snippet of R code retrieves stock price data for the S&amp;P 500 (or a similar asset) and identifies the <strong>first trading day of each year</strong> in the data.</p>
<p>Below is a step-by-step breakdown with a focus on the <strong><code>sapply</code></strong> function, which plays a key role in identifying these days.</p>
<p>We first retrieve S&amp;P 500 Data using the <code>tq_get()</code>function from the tidyquant package. We have done such and similar retrievals before, so I need not further comment on the details here. The result, <code>sp500_data</code>, is a data frame containing columns like <code>date</code>, <code>adjusted</code> (adjusted closing price), and others.</p>
<p>In a next step we extract the relevant columns Here: - <code>dates</code> is a vector of all the trading dates in the dataset. - <code>adjusted_prices</code> is a vector of the adjusted closing prices for those dates.</p>
<p>Now comes our key step, extracting unique years from the dataframe which stores daily stock prices.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>years <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">format</span>(dates, <span class="st">"%Y"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>format(dates, "%Y")</code> function converts each date into a 4-digit year (e.g., “2000”, “2001”). The <code>unique()</code> function ensures that only one instance of each year remains. The result is a vector of distinct years present in the dataset.</p>
<p>Now we want to identify the first trading day of each year</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>annual_indices <span class="ot">&lt;-</span> <span class="fu">sapply</span>(years, <span class="cf">function</span>(year) {</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">which</span>(<span class="fu">format</span>(dates, <span class="st">"%Y"</span>) <span class="sc">==</span> year)[<span class="dv">1</span>]</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To understand this code understanding <code>sapply</code> is key. The <code>sapply</code> function applies a user-defined function over each element of a vector (<code>years</code> in this case) and simplifies the result into a vector. Think of it as a way to loop through each year and calculate something for it.</p>
<p>The function inside <code>sapply</code> does the following for each <code>year</code> in <code>years</code>:</p>
<ol type="1">
<li><code>format(dates, "%Y") == year</code> creates a <strong>logical vector</strong> that checks which dates in <code>dates</code> belong to the current <code>year</code>.</li>
<li><code>which(...)[1]</code> finds the indices of <code>TRUE</code> values in the logical vector and selects the first one. This corresponds to the <strong>first trading day of the year</strong>.</li>
</ol>
<p>The <code>annual_indices</code> vector contains the indices in <code>dates</code> that correspond to the first trading day of each year.</p>
<p>Now we can extract first trading day prices and dates</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>annual_prices <span class="ot">&lt;-</span> adjusted_prices[annual_indices]</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>annual_dates <span class="ot">&lt;-</span> dates[annual_indices]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here:</p>
<ul>
<li><code>annual_prices</code> holds the adjusted prices for the first trading day of each year.</li>
<li><code>annual_dates</code> holds the corresponding dates.</li>
</ul>
<p>Here’s why <code>sapply</code> is powerful:</p>
<ol type="1">
<li><strong>Iterates Over Elements</strong>: It goes through each <code>year</code> in the <code>years</code> vector without requiring an explicit <code>for</code> loop.</li>
<li><strong>Applies a Function</strong>: It applies the provided anonymous function to each <code>year</code>. In this case, the function finds the first trading day’s index for the current year.</li>
<li><strong>Simplifies the Output</strong>: Unlike <code>lapply</code> (which returns a list), <code>sapply</code> returns a vector, making it easier to work with when you need a simple result like indices.</li>
</ol>
<p>Why Use <code>sapply</code> Instead of a Loop? While a <code>for</code> loop could achieve the same result, <code>sapply</code> is:</p>
<ul>
<li>More concise: You don’t need to explicitly initialize an output vector or update it manually.</li>
<li>Readable: It clearly expresses the idea of applying a function to each element of <code>years</code>.</li>
</ul>
<p>In terms of R programming this part of our code holds some key messages fro you:</p>
<ol type="1">
<li><strong><code>sapply</code> Simplifies Iterations</strong>: It’s a useful tool when you want to apply a function to a vector or list and return a simplified result.</li>
<li><strong>Logical Indexing with <code>which</code></strong>: The combination of <code>which</code> and logical conditions (<code>format(dates, "%Y") == year</code>) is a common way to find specific indices in R.</li>
<li><strong>Chaining Steps Together</strong>: This code demonstrates how small functions like <code>format</code>, <code>which</code>, and <code>sapply</code> can be combined to perform complex tasks efficiently.</li>
</ol>
<p>Now let us go on in our task of modelling the SP500 using the binomial lattice model. We comute the log returns in a next step and do the calibration. Not much exciting new things are going on here in terms of R. This code-part should be straightformward.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute annual log returns</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>log_returns <span class="ot">&lt;-</span> <span class="fu">diff</span>(<span class="fu">log</span>(annual_prices))  <span class="co"># Compute log(S_T / S_0)</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine into a data frame</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>annual_log_returns <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">year =</span> <span class="fu">format</span>(annual_dates[<span class="sc">-</span><span class="dv">1</span>], <span class="st">"%Y"</span>),  <span class="co"># Corresponding years for log returns</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">log_return =</span> log_returns</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters for weekly time step (1/52 years)</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Weekly time step</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>delta_t <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">52</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co">#Mean log return</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>nu <span class="ot">&lt;-</span> <span class="fu">mean</span>(annual_log_returns<span class="sc">$</span>log_return, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Variance</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>sigma_squared <span class="ot">&lt;-</span> <span class="fu">var</span>(annual_log_returns<span class="sc">$</span>log_return, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)  </span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard deviation</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(sigma_squared)  </span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Calibrate binomial model parameters</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> (nu <span class="sc">/</span> sigma) <span class="sc">*</span> <span class="fu">sqrt</span>(delta_t)</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">exp</span>(sigma <span class="sc">*</span> <span class="fu">sqrt</span>(delta_t))</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>sigma <span class="sc">*</span> <span class="fu">sqrt</span>(delta_t))</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a><span class="co"># View calibrated parameters</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>parameters <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">nu =</span> nu,</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">sigma =</span> sigma,</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> p,</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">u =</span> u,</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">d =</span> d</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>parameters</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$nu
[1] 0.06734656

$sigma
[1] 0.1768332

$p
[1] 0.5264071

$u
[1] 1.024825

$d
[1] 0.9757759</code></pre>
</div>
</div>
<p>We retrieve a series of daily prices, extract a series of annual price changes from there and then compute the parameters and pack them into a list. The precise mathematical reason why we can calibrate the model like this and why this works, we will see in lecture 5.</p>
</section>
<section id="building-the-lattice-for-loops-and-lookup-tables." class="level4" data-number="4.9.2.2">
<h4 data-number="4.9.2.2" class="anchored" data-anchor-id="building-the-lattice-for-loops-and-lookup-tables."><span class="header-section-number">4.9.2.2</span> Building the lattice: For loops and lookup tables.</h4>
<p>We are now going to build the lattice. At this stage let us just take a tiny number of time steps, so we can inspect the output of what we are doing with ease. You can later play for yourself with this code and just increase the value of <span class="math inline">\(n\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the step number</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the starting price S0 (choose most recent price)</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>S0 <span class="ot">&lt;-</span> adjusted_prices[<span class="fu">length</span>(adjusted_prices)]</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the lattice as a list</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>lattice <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, n <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the lattice</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (step <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>n) {</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  prices <span class="ot">&lt;-</span> <span class="fu">numeric</span>(step <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>step) {</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    prices[i <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> S0 <span class="sc">*</span> u<span class="sc">^</span>i <span class="sc">*</span> d<span class="sc">^</span>(step <span class="sc">-</span> i)</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>  lattice[[step <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> prices</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="co"># View the lattice</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>lattice</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 586.08

[[2]]
[1] 571.8827 600.6297

[[3]]
[1] 558.0294 586.0800 615.5407

[[4]]
[1] 544.5116 571.8827 600.6297 630.8218</code></pre>
</div>
</div>
<p>This code snippet uses <strong><code>for</code> loops</strong> and a <strong>lookup table</strong> to build a binomial lattice. Both are important concepts when writing R programs-</p>
<p>Let’s break it down step by step, focusing on the programming concepts involved.</p>
<p>A <code>for</code> loop in R iterates over a sequence of values, executing a block of code for each value. Its syntax is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (variable <span class="cf">in</span> sequence) {</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Code to execute in each iteration</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In our code we have two loops: An <em>outer loop</em> <code>for (step in 0:n) {</code>. This loop iterates through each step of the lattice, from <code>0</code> to <code>n</code> (the total number of time steps in the model). The variable <code>step</code> represents the current level of the lattice.</p>
<p>The <em>inner loop</em> <code>for (i in 0:step) {</code>: For each level of the lattice (<code>step</code>), this loop iterates over the possible nodes (prices) at that level. The variable <code>i</code> represents the number of upward moves at this level.</p>
<p>A <strong>lookup table</strong> is a data structure that stores values for quick access, allowing computations to refer to pre-calculated data instead of recomputing it repeatedly.</p>
<p>In this example, the <strong>lattice itself is the lookup table</strong>. It stores the prices at each step and node of the lattice in a list structure:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>  lattice[[step <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> prices</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Each element of <code>lattice</code> corresponds to a time step. <code>lattice[[step + 1]]</code> stores a numeric vector containing all possible prices at the <code>step</code> level of the lattice.</p>
<p>Now here’s how the code uses <code>for</code> loops and a lookup table to build the binomial lattice:</p>
<p>We first initialize the lattice by <code>lattice &lt;- vector("list", n + 1)</code>. A list of size <code>n + 1</code> is created to store the prices for each step of the lattice (from step <code>0</code> to step <code>n</code>). Lists are ideal here because they allow each element to store a vector of prices, with the number of prices varying at each step.</p>
<p>Pre-allocating space for the output is good practice when writing <code>for</code> loops in R (or any other programming language) because it significantly improves performance and readability. Here’s why: It <strong>avoids repeated memory allocation</strong>: If you grow an object inside a loop (e.g., using <code>c()</code> to append values), R reallocates memory every time the object changes size. This is computationally expensive, especially for large loops.</p>
<p>By pre-allocating the required space, memory is allocated only once, and the values are directly written into the reserved space, saving computation time.</p>
<p>Pre-allocation makes the structure of the output clear before the loop begins and <strong>improves code readability</strong>. Readers can immediately understand the size and type of the expected result.</p>
<p>Finally it <strong>avoids unnecessary complexity</strong>: Growing objects dynamically can make the code harder to follow and debug.</p>
<p>Pre-allocation ensures better performance and cleaner, more professional code!</p>
<p>Let’s look a bit closer into what our loops do:</p>
<p>The <strong>Outer Loop</strong> iterates over each step of the lattice. At each step, a new vector <code>prices</code> is created to store the prices for that level.</p>
<p>The <strong>Inner Loop</strong> computes the price for each node at the current step. For node <code>i</code>, the price is calculated using: <span class="math display">\[
S_i = S_0 \cdot u^i \cdot d^{\text{step} - i}
\]</span> The result is stored in the <code>prices</code> vector, with indices adjusted for R’s 1-based indexing (<code>i + 1</code>).</p>
<p>After computing all prices for the current step, the <code>prices</code> vector is added to the <code>lattice</code> lookup table at index <code>step + 1</code>.</p>
<p>The final <code>lattice</code> contains all possible prices at each step, structured as a list: - <code>lattice[[1]]</code>: Prices at step 0 (initial price, <code>S0</code>). - <code>lattice[[2]]</code>: Prices at step 1 (two possible prices: up and down). - And so on, up to <code>lattice[[n + 1]]</code>.</p>
<p>Let us visualize the lattice. This, of course, only makes sense for small nubers of time steps because the lattice grows rapidly as the time steps get bigger. For our visualization here I use the <code>ggplot2</code> library, a great library for visualization of all kinds with a consistent “grammar of graphics”.</p>
<p>Let us prepare the data for our plot first:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for plotting</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Step =</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span>n, <span class="at">times =</span> <span class="fu">seq_len</span>(n <span class="sc">+</span> <span class="dv">1</span>)),  <span class="co"># x-coordinates</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Price =</span> <span class="fu">unlist</span>(lattice),                 <span class="co"># y-coordinates</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Label =</span> <span class="fu">round</span>(<span class="fu">unlist</span>(lattice), <span class="dv">2</span>)        <span class="co"># Labels with rounded prices</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create edges for connections</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="cf">function</span>(step) {</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">rep</span>(step <span class="sc">-</span> <span class="dv">1</span>, <span class="at">times =</span> step),           <span class="co"># Starting x-coordinates</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">xend =</span> <span class="fu">rep</span>(step, <span class="at">times =</span> step),           <span class="co"># Ending x-coordinates</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> lattice[[step]],                      <span class="co"># Starting y-coordinates</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">yend =</span> <span class="fu">c</span>(lattice[[step <span class="sc">+</span> <span class="dv">1</span>]][<span class="sc">-</span><span class="dv">1</span>], lattice[[step <span class="sc">+</span> <span class="dv">1</span>]][<span class="sc">-</span><span class="fu">length</span>(lattice[[step <span class="sc">+</span> <span class="dv">1</span>]])]) <span class="co"># Ending y-coordinates</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>}))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This part of the code needs some explanation:</p>
<p>The code prepares two main components: data for plotting the nodes (prices at each step) and data for connecting those nodes with edges (showing transitions between prices).</p>
<p>To prepare the nodes, we create a <code>data.frame</code> for the lattice’s nodes, which represent the prices at each step in the lattice.</p>
<ol type="1">
<li><p><code>Step</code> (x-coordinates):</p>
<ul>
<li><code>rep(0:n, times = seq_len(n + 1))</code> creates a vector repeating each step number (<code>0:n</code>) a specific number of times.</li>
<li><code>seq_len(n + 1)</code> generates the sequence of repetitions: <code>1, 2, 3, ..., n + 1</code>. This ensures that:
<ul>
<li>At step 0, there’s 1 node.</li>
<li>At step 1, there are 2 nodes.</li>
<li>At step 2, there are 3 nodes, and so on.</li>
</ul></li>
<li>Example for <code>n = 2</code>: <code>Step = c(0, 1, 1, 2, 2, 2)</code>.</li>
</ul></li>
<li><p><code>Price</code> (y-coordinates):</p>
<ul>
<li><code>unlist(lattice)</code> flattens the list <code>lattice</code> into a single vector.</li>
<li><code>lattice</code> is assumed to be a list where each element corresponds to the prices (y-coordinates) at a specific step in the lattice.</li>
<li>For instance, if <code>lattice = list(c(100), c(110, 90), c(121, 100, 81))</code>, then <code>unlist(lattice)</code> produces <code>c(100, 110, 90, 121, 100, 81)</code>.</li>
</ul></li>
<li><p><code>Label</code>:</p>
<ul>
<li><code>round(unlist(lattice), 2)</code> creates rounded labels for the prices, suitable for display in a plot.</li>
</ul></li>
</ol>
<p>The resulting <code>data.frame</code> contains three columns:</p>
<ul>
<li><code>Step</code>: The x-coordinate (time step).</li>
<li><code>Price</code>: The y-coordinate (price value).</li>
<li><code>Label</code>: Rounded price values for display.</li>
</ul>
<p>To create the edges we need to prepare the connections between nodes, which represent the transitions between prices at consecutive steps. Here is what is going on</p>
<ol type="1">
<li><p>Outer Loop with <code>lapply</code>:</p>
<ul>
<li>Loops over each step (<code>1:n</code>) in the lattice. For each step:
<ul>
<li>Connections are created between the nodes at the current step (<code>step - 1</code>) and the next step (<code>step</code>).</li>
</ul></li>
</ul></li>
<li><p>Starting Coordinates (<code>x</code>, <code>y</code>):</p>
<ul>
<li><code>x</code>: <code>rep(step - 1, times = step)</code> sets the starting x-coordinate for all connections at step <code>step</code>.
<ul>
<li>E.g., for step 1, <code>x = rep(0, 1)</code>; for step 2, <code>x = rep(1, 2)</code>.</li>
</ul></li>
<li><code>y</code>: <code>lattice[[step]]</code> provides the y-coordinates (prices) of the starting nodes.</li>
</ul></li>
<li><p>Ending Coordinates (<code>xend</code>, <code>yend</code>):</p>
<ul>
<li><code>xend</code>: <code>rep(step, times = step)</code> sets the ending x-coordinate for all connections at the next step.</li>
<li><code>yend</code>: The tricky part! It selects the y-coordinates of the ending nodes:
<ul>
<li><code>lattice[[step + 1]][-1]</code>: Removes the first price at the next step.</li>
<li><code>lattice[[step + 1]][-length(lattice[[step + 1]])]</code>: Removes the last price at the next step.</li>
<li>Combined using <code>c(...)</code> to connect prices at step <code>step</code> to both upward and downward transitions at step <code>step + 1</code>.</li>
</ul></li>
</ul></li>
<li><p><strong><code>do.call(rbind, ...)</code>:</strong></p>
<ul>
<li>Combines all the individual <code>data.frame</code> objects (one per step) into a single <code>data.frame</code> with the connection data.</li>
</ul></li>
</ol>
<p>The resulting <code>edges</code> <code>data.frame</code> has four columns:</p>
<ul>
<li><code>x</code>: Starting x-coordinates.</li>
<li><code>xend</code>: Ending x-coordinates.</li>
<li><code>y</code>: Starting y-coordinates.</li>
<li><code>yend</code>: Ending y-coordinates.</li>
</ul>
<p>This is a good opprotubity for <strong>understanding <code>lapply</code> and <code>do.call</code>:</strong></p>
<ul>
<li><code>lapply</code> applies a function to each element of a sequence (steps here) and returns a list of results.</li>
<li><code>do.call(rbind, ...)</code> merges the list of <code>data.frame</code>s into a single <code>data.frame</code>.</li>
</ul>
<p>Now we can do our visualization:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load ggplot2 library</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add edges</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">data =</span> edges, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend),</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> <span class="st">"gray"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add nodes</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> plot_data, <span class="fu">aes</span>(<span class="at">x =</span> Step, <span class="at">y =</span> Price), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add price labels</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> plot_data, <span class="fu">aes</span>(<span class="at">x =</span> Step, <span class="at">y =</span> Price, <span class="at">label =</span> Label),</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Enriched Binomial Lattice with Prices for S&amp;P 500"</span>,</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Step"</span>, <span class="at">y =</span> <span class="st">"Price"</span>) <span class="sc">+</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04-lecture4_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Before we go through the syntax of this code snippet let me first briefly introduce you to the logic of <code>ggplot2</code></p>
<p>The <strong><code>ggplot2</code></strong> package is one of the most popular tools in R for creating visualizations. It uses a <strong>layered grammar of graphics</strong>, which means you build a plot step-by-step by adding layers. Each layer corresponds to a specific aspect of the visualization, such as:</p>
<ol type="1">
<li><strong>The Data:</strong> Define the dataset you want to visualize.</li>
<li><strong>Aesthetic Mappings (<code>aes</code>)</strong>: Specify how variables in your data map to visual properties (e.g., x/y positions, colors, sizes).</li>
<li><strong>Geometries (<code>geom_</code>)</strong>: Add geometric objects like points, lines, or bars to represent the data visually.</li>
<li><strong>Themes and Labels:</strong> Customize the look of the plot (theme) and annotate it with titles, axis labels, etc.</li>
</ol>
<p>With this understanding, let’s break down the provided code.</p>
<hr>
</section>
</section>
<section id="the-code-building-a-binomial-lattice-plot" class="level3" data-number="4.9.3">
<h3 data-number="4.9.3" class="anchored" data-anchor-id="the-code-building-a-binomial-lattice-plot"><span class="header-section-number">4.9.3</span> The Code: Building a Binomial Lattice Plot</h3>
<p>We first create a plot base through <code>ggplot() +</code>:</p>
<ul>
<li>This initializes an empty plot. The <code>ggplot()</code> function can take a dataset as its argument, but in this case, it’s left empty because the plot will use multiple datasets (<code>edges</code> and <code>plot_data</code>) added in later layers.</li>
</ul>
<p>In the next step we add edges by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_segment</span>(<span class="at">data =</span> edges, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend),</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"gray"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p><code>geom_segment</code>: This geometry adds line segments (edges) to the plot. Each segment connects a starting point <code>(x, y)</code> to an ending point <code>(xend, yend)</code>.</p></li>
<li><p><code>data = edges</code>: Specifies that this layer uses the <code>edges</code> dataset, which contains the start and end coordinates of each edge.</p></li>
<li><p><code>aes(x = x, y = y, xend = xend, yend = yend)</code>: Maps the start (<code>x</code>, <code>y</code>) and end (<code>xend</code>, <code>yend</code>) points for the edges from the <code>edges</code> dataset.</p></li>
<li><p>Styling:</p>
<ul>
<li><code>color = "gray"</code> makes the edges gray.</li>
<li><code>linetype = "dashed"</code> creates dashed lines to distinguish the edges visually.</li>
</ul></li>
</ul>
<p>Now we add nodes by evoking:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_point</span>(<span class="at">data =</span> plot_data, <span class="fu">aes</span>(<span class="at">x =</span> Step, <span class="at">y =</span> Price), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p><code>geom_point</code>: This geometry adds points (nodes) to the plot.</p></li>
<li><p><code>data = plot_data</code>: Specifies the dataset containing node information.</p></li>
<li><p><code>aes(x = Step, y = Price)</code>: Maps the <code>Step</code> (x-axis) and <code>Price</code> (y-axis) variables from the <code>plot_data</code> dataset.</p></li>
<li><p>Styling:</p>
<ul>
<li><code>color = "blue"</code> sets the points’ color.</li>
<li><code>size = 2</code> adjusts the size of the points to make them visible but not overpowering.</li>
</ul></li>
</ul>
<p>Nex we add price labels by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_text</span>(<span class="at">data =</span> plot_data, <span class="fu">aes</span>(<span class="at">x =</span> Step, <span class="at">y =</span> Price, <span class="at">label =</span> Label),</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p><code>geom_text</code>: This geometry adds text labels to the plot.</p></li>
<li><p><code>data = plot_data</code>: Uses the same dataset as the nodes, since labels correspond to the nodes.</p></li>
<li><p><code>aes(x = Step, y = Price, label = Label)</code>:</p>
<ul>
<li><p><code>x = Step</code> and <code>y = Price</code> position the labels at the nodes.</p></li>
<li><p><code>label = Label</code> specifies the text to display, which is the rounded price values from the <code>Label</code> column.</p></li>
</ul></li>
<li><p>Styling:</p>
<ul>
<li><p><code>color = "black"</code> sets the text color.</p></li>
<li><p><code>vjust = -0.5</code> adjusts the vertical alignment of the labels so they appear slightly above the nodes.</p></li>
<li><p><code>size = 3</code> adjusts the font size.</p></li>
</ul></li>
</ul>
<p>Finally we define the plot lables and add the <code>minimal</code>theme from the library of themes provided by <code>ggplot2</code>.</p>
<p>The resulting plot will look like:</p>
<ul>
<li><p><strong>A binomial lattice</strong> with:</p>
<ul>
<li><p>Dashed gray edges connecting nodes, representing the upward and downward transitions.</p></li>
<li><p>Blue points for each node in the lattice, representing prices at different steps.</p></li>
<li><p>Black text labels above the nodes, displaying the rounded price values.</p></li>
<li><p>A clean and minimal design with a title and labeled axes.</p></li>
</ul></li>
</ul>
<p>This code demonstrates how to layer multiple datasets (nodes and edges) in a single visualization using <code>ggplot2</code>. By carefully controlling each layer and its aesthetic mappings, you can create complex and informative visualizations.</p>
<section id="exploring-the-lattice-flow-control" class="level4" data-number="4.9.3.1">
<h4 data-number="4.9.3.1" class="anchored" data-anchor-id="exploring-the-lattice-flow-control"><span class="header-section-number">4.9.3.1</span> Exploring the Lattice: Flow Control</h4>
<p>We can now use our lattice to demonstrate some other R programing tools. Let us explore the lattice by using <code>while</code>loops to traverse the lattice and compute specific properties (e.g., maximum or minimum price).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Traverse lattice to find maximum price</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>max_price <span class="ot">&lt;-</span> <span class="sc">-</span><span class="cn">Inf</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>step <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (step <span class="sc">&lt;=</span> <span class="fu">length</span>(lattice)) {</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  max_price <span class="ot">&lt;-</span> <span class="fu">max</span>(max_price, <span class="fu">max</span>(lattice[[step]]))</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  step <span class="ot">&lt;-</span> step <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>max_price</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 630.8218</code></pre>
</div>
</div>
<p>This code traverses through a <strong>binomial lattice</strong> (stored as a list of price vectors) to find the <strong>maximum price</strong> across all steps. Along the way, it introduces the concept of an R <code>while</code> loop, which is a fundamental control structure used for iterative computations.</p>
<p>We first initialize the variables <code>max_price</code> and <code>step</code>-</p>
<ul>
<li><code>max_price</code>: This variable keeps track of the maximum price found so far.
<ul>
<li>It is initialized to <code>-Inf</code> (negative infinity) because any price in the lattice will be greater than this value, ensuring the first price comparison updates it.</li>
</ul></li>
<li><code>step</code>: This variable represents the current step (or level) of the lattice being processed. It starts at <code>1</code> to access the first step in the lattice.</li>
</ul>
<p>In R, <strong><code>Inf</code></strong> (infinity) and <strong><code>-Inf</code></strong> (negative infinity) are special numeric constants that represent values beyond the largest or smallest numbers R can handle. They are used in mathematical operations and comparisons where results exceed the limits of finite numbers.</p>
<p><code>Inf</code> is larger than any finite number, and <code>-Inf</code> is smaller than any finite number. <code>Inf</code> and <code>-Inf</code> are commonly used as initial values in iterative algorithms. For example:</p>
<ul>
<li><p><code>max_price &lt;- -Inf</code> ensures any number compared to it will update the value.</p></li>
<li><p><code>min_price &lt;- Inf</code> works similarly for finding the smallest value.</p></li>
</ul>
<p>After this short excursion into <code>Inf</code> and <code>-Inf</code> in R we now come to the step where we transverse the lattice using a <code>while</code>loop.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (step <span class="sc">&lt;=</span> <span class="fu">length</span>(lattice)) {</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  max_price <span class="ot">&lt;-</span> <span class="fu">max</span>(max_price, <span class="fu">max</span>(lattice[[step]]))</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  step <span class="ot">&lt;-</span> step <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here are the key Concepts of a <code>while</code> Loop:</p>
<ul>
<li>A <code>while</code> loop repeats a block of code <strong>as long as the condition remains <code>TRUE</code></strong>.</li>
<li>It’s useful when the number of iterations isn’t predetermined and depends on a condition being met.</li>
</ul>
<p>Here’s how it works in this snippet:</p>
<ol type="1">
<li><p>Condition (<code>step &lt;= length(lattice)</code>):</p>
<ul>
<li>The loop continues as long as <code>step</code> is less than or equal to the number of steps in the lattice (<code>length(lattice)</code>).</li>
<li>This ensures every level of the lattice is checked.</li>
</ul></li>
<li><p>Update Maximum Price:</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>   max_price <span class="ot">&lt;-</span> <span class="fu">max</span>(max_price, <span class="fu">max</span>(lattice[[step]]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><code>lattice[[step]]</code>: Accesses the vector of prices at the current step.</li>
<li><code>max(lattice[[step]])</code>: Finds the maximum price at the current step.</li>
<li><code>max(max_price, ...)</code>: Updates <code>max_price</code> with the larger value between the current <code>max_price</code> and the maximum price at the current step.</li>
</ul>
<ol start="3" type="1">
<li>The expression <code>step &lt;- step + 1</code> is the so called **increment <code>step</code>: After processing the current step, the <code>step</code> variable is increased by 1 to move to the next step in the lattice.</li>
</ol>
<p>After the loop completes, <code>max_price</code> contains the maximum price found across all steps of the lattice.</p>
<p>The <strong>General Structure of a <code>while</code> Loop:</strong> is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>   <span class="cf">while</span> (condition) {</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>       <span class="co"># Code block to execute</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>   }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>The loop runs as long as the <code>condition</code> evaluates to <code>TRUE</code>.</li>
<li>You must ensure the condition eventually becomes <code>FALSE</code>; otherwise, the loop will run indefinitely (infinite loop).</li>
</ul>
<p>The key Features in our example:</p>
<ul>
<li><strong>Initialization:</strong> Variables (<code>max_price</code>, <code>step</code>) are set up before the loop.</li>
<li><strong>Condition Check:</strong> The loop continues as long as <code>step &lt;= length(lattice)</code>.</li>
<li><strong>Update Mechanism:</strong> Both <code>max_price</code> and <code>step</code> are updated within the loop, ensuring progress toward termination.</li>
</ul>
<p>The common use case for while loops are:</p>
<ul>
<li>When the number of iterations isn’t known beforehand (e.g., processing until a condition is met).</li>
<li>Traversing a list or dataset, as in this example.</li>
</ul>
<p>It is best practice to:</p>
<ul>
<li>Always ensure the condition can eventually become <code>FALSE</code>.</li>
<li>Use <code>print</code> or <code>cat</code> statements inside the loop to debug and see intermediate results.</li>
</ul>
</section>
<section id="does-the-price-exceed-a-threshold-conditional-statements-to-annotate-whether-a-price-exceeds-a-certain-threshold." class="level4" data-number="4.9.3.2">
<h4 data-number="4.9.3.2" class="anchored" data-anchor-id="does-the-price-exceed-a-threshold-conditional-statements-to-annotate-whether-a-price-exceeds-a-certain-threshold."><span class="header-section-number">4.9.3.2</span> Does the price exceed a threshold?: Conditional statements to annotate whether a price exceeds a certain threshold.</h4>
<p>Let’s consider next this codes snippet. It helps us finding out whether a price in the lattice exceeds a particular threshold. This is a question you will ask yourself often when analyzing options, for example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Annotate prices exceeding 4100</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>threshold <span class="ot">&lt;-</span> <span class="dv">4100</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (step <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>n) {</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(lattice[[step <span class="sc">+</span> <span class="dv">1</span>]])) {</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (lattice[[step <span class="sc">+</span> <span class="dv">1</span>]][i] <span class="sc">&gt;</span> threshold) {</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Price exceeds threshold at step"</span>, step, <span class="st">":"</span>, lattice[[step <span class="sc">+</span> <span class="dv">1</span>]][i]))</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This code snippet traverses the <strong>binomial lattice</strong> (stored as a list of price vectors) to identify and print prices exceeding a given threshold (<code>4100</code>). It uses <strong>nested <code>for</code> loops</strong> to navigate through the lattice and an <strong><code>if</code> conditional statement</strong> to check whether each price exceeds the threshold.</p>
<p>In the beginning we define our threshold by <code>threshold &lt;- 4100</code>. Any price greater than this value will trigger a message.</p>
<p>We have an outer loop</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (step <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>n) {</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>The <code>for</code> loop iterates over the steps of the lattice, from <code>0</code> (the initial step) to <code>n</code> (the final step).</li>
<li>Each <code>step</code> represents a time period or level in the lattice.</li>
</ul>
<p>We also have an inner loop to traverse prices within each step, which is in the code segment</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(lattice[[step <span class="sc">+</span> <span class="dv">1</span>]])) {</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><code>lattice[[step + 1]]</code>:
<ul>
<li>Accesses the list element for the current step (<code>step + 1</code> because R uses 1-based indexing).</li>
<li>This element is a vector of prices at the given step.</li>
</ul></li>
<li><code>seq_along(...)</code>:
<ul>
<li>Creates a sequence from <code>1</code> to the length of <code>lattice[[step + 1]]</code>.</li>
<li>This ensures that every price in the current step is checked.</li>
</ul></li>
<li>The <code>i</code> variable is the index of a price in the vector <code>lattice[[step + 1]]</code>.</li>
</ul>
<p>Now comes a new concept: A <strong>conditional statement</strong> to check the threshold:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (lattice[[step <span class="sc">+</span> <span class="dv">1</span>]][i] <span class="sc">&gt;</span> threshold) {</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Price exceeds threshold at step"</span>, step, <span class="st">":"</span>, lattice[[step <span class="sc">+</span> <span class="dv">1</span>]][i]))</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let me explain the syntax of the if statment in R:</p>
<ul>
<li>Condition:<code>lattice[[step + 1]][i] &gt; threshold</code>
<ul>
<li>Checks whether the price at index <code>i</code> in the current step is greater than the threshold.</li>
</ul></li>
<li>If the condition evaluates to <code>TRUE</code>:
<ul>
<li>Executes the code inside the curly braces <code>{...}</code>.</li>
<li>In this case, it prints a message containing:
<ul>
<li>The <code>step</code> number.</li>
<li>The price (<code>lattice[[step + 1]][i]</code>) that exceeds the threshold.</li>
</ul></li>
</ul></li>
</ul>
<p>When Condition is <code>FALSE</code>: If the condition evaluates to <code>FALSE</code> (price does not exceed the threshold), the code inside the braces is skipped.</p>
<p>The general structure of an <code>if</code> statement in R is</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (condition) {</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Code to execute if condition is TRUE</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p><code>condition</code>:</p>
<ul>
<li><p>A logical expression that evaluates to <code>TRUE</code> or <code>FALSE</code>.</p></li>
<li><p>Can involve comparisons (<code>&gt;</code>, <code>&lt;</code>, <code>==</code>, <code>!=</code>, etc.), logical operators (<code>&amp;</code>, <code>|</code>, <code>!</code>), or built-in R functions.</p></li>
</ul></li>
<li><p>If the <code>condition</code> is <code>TRUE</code>, the code block inside <code>{}</code> is executed.</p></li>
<li><p>If the <code>condition</code> is <code>FALSE</code>, the code block is skipped.</p></li>
</ul>
<p>You always have the option to extend a conditional statement by an <code>else</code> block:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (condition) {</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Code to execute if condition is TRUE</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Code to execute if condition is FALSE</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="programming-in-r-the-binomial-lattic-model-1" class="level2" data-number="4.10">
<h2 data-number="4.10" class="anchored" data-anchor-id="programming-in-r-the-binomial-lattic-model-1"><span class="header-section-number">4.10</span> Programming in R: The binomial lattic model</h2>
<p>The <strong>binomial lattice model</strong> is a simple yet powerful framework for simulating asset price dynamics under uncertainty. It is widely used in financial modeling, particularly in pricing derivative securities like options, as it captures the probabilistic nature of price movements in discrete time. At each time step, an asset can either move up or down by a specified factor, creating a lattice of possible price paths. It is an excellent application case for discrete random variables but also for an introduction to writing more complex programs in R.</p>
<p>In this lecture, we will apply the binomial lattice model to simulate the dynamics of a stock index which we have now used several times in this lecture: the S&amp;P 500. This example provides a practical use case to reinforce programming concepts while exploring a key tool in financial mathematics.</p>
<p>You will learn how to:</p>
<ul>
<li>Write more complex R programs, including functions for creating and exploring the lattice.</li>
<li>Use control structures like loops (<code>for</code>, <code>while</code>, <code>repeat</code>) and conditional statements (<code>if</code>, <code>else</code>).</li>
<li>Understand and leverage R’s powerful <strong>list structure</strong> for organizing and manipulating data.</li>
<li>Apply modular programming principles to write reusable, maintainable code.</li>
</ul>
<p>By the end of this session, you’ll not only have a deeper understanding of the binomial lattice model but also the computational tools to extend this approach to more complex scenarios in financial modeling.</p>
<section id="the-binomial-lattice-model-1" class="level3" data-number="4.10.1">
<h3 data-number="4.10.1" class="anchored" data-anchor-id="the-binomial-lattice-model-1"><span class="header-section-number">4.10.1</span> The binomial lattice model</h3>
<p>To define the binomia lattice model, we need to establish a basic period length, say 1 week or one day. The model describes a situation where we know the price at the beginning of the period. The price at the beginning of the next period is one of only two possible values. Usually these possibilities are defined as multiples of the price in the previous period, a multiple <span class="math inline">\(u\)</span> (for up) and <span class="math inline">\(d\)</span> (for down). Both <span class="math inline">\(u\)</span> and <span class="math inline">\(d\)</span> are positive with <span class="math inline">\(u &gt; 1\)</span> and <span class="math inline">\(d &lt; 1\)</span>. Hence when the price at the beginning of the period is <span class="math inline">\(S\)</span>, it will be <span class="math inline">\(uS\)</span> or <span class="math inline">\(dS\)</span> at the beginning of the next period. The probabilities of these outcomes are given by <span class="math inline">\(p\)</span> and <span class="math inline">\(1-p\)</span>. This model continues for several periods.</p>
<p>By now you will recognize that the outcomes of this model will be well described by a binomial random variable. The model is equivalent to tossing a coin multiple times.</p>
<p>This binomial lattice model is fundamentally linked to the binomial distribution. Consider the price after <span class="math inline">\(n\)</span> periods. Each period represents a trial where the price either moves up (<span class="math inline">\(u\)</span>) or down (<span class="math inline">\(d\)</span>), with probabilities <span class="math inline">\(p\)</span> and <span class="math inline">\(1−p\)</span>, respectively. The total price after <span class="math inline">\(n\)</span> periods depends on the number of upward movements, denoted by <span class="math inline">\(k\)</span>, and is given by:</p>
<p><span class="math display">\[
S_n = S_0 \times  u^k \times d^{n−k}
\]</span></p>
<p>where <span class="math inline">\(k\)</span> is the number of “up” movements and <span class="math inline">\(n−k\)</span> is the number of “down” movements.</p>
<p>The distribution of <span class="math inline">\(k\)</span> follows a binomial distribution: <span class="math display">\[
P(k) = \binom{n}{k} p^k (1-p)^{n-k}, \quad k = 0, 1, 2, \dots, n
\]</span> which describes the likelihood of observing <span class="math inline">\(k\)</span> upward movements out of <span class="math inline">\(n\)</span> trials.</p>
<p>This model may seem too simplistic for describing the price dynamics of a stock index, because there are only two possible outcomes per period.</p>
<p>But when you make the connection to the binomial distribution you will realize how this restriction becomes less severe when <span class="math inline">\(\Delta t\)</span> the time steps are small: the random variable <span class="math inline">\(k\)</span>, representing the count of up movements, directly determines the possible price levels of the asset. Over many periods <span class="math inline">\(n\)</span>, this simple two-step structure generates a range of prices consistent with the binomial distribution. This relationship also explains why the model becomes increasingly flexible and realistic as the number of periods grows, enabling it to approximate more complex price dynamics.</p>
<p>Because the model is multiplicative, the price will never become negative. We can thus work with the logarithm of the price as our fundamental variable.</p>
<p>Accordinglly, we define <span class="math inline">\(\nu\)</span> as the expected annual growth rate <span class="math display">\[
\nu = \mathbb[\ln(S_T/S_0)]
\]</span> where <span class="math inline">\(S_0\)</span> is the initial stock price and <span class="math inline">\(S_T\)</span> is the price at the end of the year. Likewise we define the variance as <span class="math display">\[
\sigma^2=\text{var}[\ln(S_T/S_0)]
\]</span></p>
<p>If the period length <span class="math inline">\(\Delta t\)</span> is chosen small compared to 1, the parameters of the binomial lattice can be selected as: <span class="math display">\[\begin{eqnarray}
p &amp;=&amp; \frac{1}{2} + \frac{1}{2}\left(\frac{\nu}{\sigma}\right) \sqrt{\Delta t} \\
u &amp;=&amp; \exp(\sigma \sqrt{\Delta t}) \\
d &amp;=&amp; \exp(- \sigma \sqrt{\Delta t})
\end{eqnarray}\]</span></p>
<p>This means - for instance - that if <span class="math inline">\(\Delta t\)</span> is one week the time scaling factor would be <span class="math inline">\(\sqrt{1/52}\)</span> if it is a day it would be <span class="math inline">\(\sqrt{1/252}\)</span> assuming 252 trading days in a year.</p>
</section>
<section id="modelling-the-dynamics-of-the-sp500-1" class="level3" data-number="4.10.2">
<h3 data-number="4.10.2" class="anchored" data-anchor-id="modelling-the-dynamics-of-the-sp500-1"><span class="header-section-number">4.10.2</span> Modelling the Dynamics of the SP500</h3>
<section id="calibrating-the-model-paraemters-from-data-1" class="level4" data-number="4.10.2.1">
<h4 data-number="4.10.2.1" class="anchored" data-anchor-id="calibrating-the-model-paraemters-from-data-1"><span class="header-section-number">4.10.2.1</span> Calibrating the model paraemters from data</h4>
<p>As a use case we make a model which we calibrate to the SP500, a broad stock market index that we have used already before in our lectures. Let#s get the S&amp;P data using the <code>tidyquant</code>package:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load necessary libraries</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyquant)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We start by retrieving the data first. I use the SP500 ticker symbol <code>^GSPC</code> here. You could also use <code>SPY</code> which is an ETF tracking the SP500.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve S&amp;P 500 data (adjust ticker as needed)</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>sp500_data <span class="ot">&lt;-</span> <span class="fu">tq_get</span>(<span class="st">"SPY"</span>, <span class="at">from =</span> <span class="st">"2000-01-01"</span>, <span class="at">to =</span> <span class="st">"2025-01-01"</span>, <span class="at">get =</span> <span class="st">"stock.prices"</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract adjusted prices and dates</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>dates <span class="ot">&lt;-</span> sp500_data<span class="sc">$</span>date</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>adjusted_prices <span class="ot">&lt;-</span> sp500_data<span class="sc">$</span>adjusted</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the first trading day of each year</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>years <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">format</span>(dates, <span class="st">"%Y"</span>))  <span class="co"># Extract unique years</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>annual_indices <span class="ot">&lt;-</span> <span class="fu">sapply</span>(years, <span class="cf">function</span>(year) {</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">which</span>(<span class="fu">format</span>(dates, <span class="st">"%Y"</span>) <span class="sc">==</span> year)[<span class="dv">1</span>]  <span class="co"># Get the first trading day of the year</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract prices and dates for the first trading day of each year</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>annual_prices <span class="ot">&lt;-</span> adjusted_prices[annual_indices]</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>annual_dates <span class="ot">&lt;-</span> dates[annual_indices]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let me unpack this code-chunk a bit, especially focusing on how we use R to extract the first trading day in each year.</p>
<p>This snippet of R code retrieves stock price data for the S&amp;P 500 (or a similar asset) and identifies the <strong>first trading day of each year</strong> in the data.</p>
<p>Below is a step-by-step breakdown with a focus on the <strong><code>sapply</code></strong> function, which plays a key role in identifying these days.</p>
<p>We first retrieve S&amp;P 500 Data using the <code>tq_get()</code>function from the tidyquant package. We have done such and similar retrievals before, so I need not further comment on the details here. The result, <code>sp500_data</code>, is a data frame containing columns like <code>date</code>, <code>adjusted</code> (adjusted closing price), and others.</p>
<p>In a next step we extract the relevant columns Here: - <code>dates</code> is a vector of all the trading dates in the dataset. - <code>adjusted_prices</code> is a vector of the adjusted closing prices for those dates.</p>
<p>Now comes our key step, extracting unique years from the dataframe which stores daily stock prices.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>years <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">format</span>(dates, <span class="st">"%Y"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>format(dates, "%Y")</code> function converts each date into a 4-digit year (e.g., “2000”, “2001”). The <code>unique()</code> function ensures that only one instance of each year remains. The result is a vector of distinct years present in the dataset.</p>
<p>Now we want to identify the first trading day of each year</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>annual_indices <span class="ot">&lt;-</span> <span class="fu">sapply</span>(years, <span class="cf">function</span>(year) {</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">which</span>(<span class="fu">format</span>(dates, <span class="st">"%Y"</span>) <span class="sc">==</span> year)[<span class="dv">1</span>]</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To understand this code understanding <code>sapply</code> is key. The <code>sapply</code> function applies a user-defined function over each element of a vector (<code>years</code> in this case) and simplifies the result into a vector. Think of it as a way to loop through each year and calculate something for it.</p>
<p>The function inside <code>sapply</code> does the following for each <code>year</code> in <code>years</code>:</p>
<ol type="1">
<li><code>format(dates, "%Y") == year</code> creates a <strong>logical vector</strong> that checks which dates in <code>dates</code> belong to the current <code>year</code>.</li>
<li><code>which(...)[1]</code> finds the indices of <code>TRUE</code> values in the logical vector and selects the first one. This corresponds to the <strong>first trading day of the year</strong>.</li>
</ol>
<p>The <code>annual_indices</code> vector contains the indices in <code>dates</code> that correspond to the first trading day of each year.</p>
<p>Now we can extract first trading day prices and dates</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>annual_prices <span class="ot">&lt;-</span> adjusted_prices[annual_indices]</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>annual_dates <span class="ot">&lt;-</span> dates[annual_indices]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here:</p>
<ul>
<li><code>annual_prices</code> holds the adjusted prices for the first trading day of each year.</li>
<li><code>annual_dates</code> holds the corresponding dates.</li>
</ul>
<p>Here’s why <code>sapply</code> is powerful:</p>
<ol type="1">
<li><strong>Iterates Over Elements</strong>: It goes through each <code>year</code> in the <code>years</code> vector without requiring an explicit <code>for</code> loop.</li>
<li><strong>Applies a Function</strong>: It applies the provided anonymous function to each <code>year</code>. In this case, the function finds the first trading day’s index for the current year.</li>
<li><strong>Simplifies the Output</strong>: Unlike <code>lapply</code> (which returns a list), <code>sapply</code> returns a vector, making it easier to work with when you need a simple result like indices.</li>
</ol>
<p>Why Use <code>sapply</code> Instead of a Loop? While a <code>for</code> loop could achieve the same result, <code>sapply</code> is:</p>
<ul>
<li>More concise: You don’t need to explicitly initialize an output vector or update it manually.</li>
<li>Readable: It clearly expresses the idea of applying a function to each element of <code>years</code>.</li>
</ul>
<p>In terms of R programming this part of our code holds some key messages fro you:</p>
<ol type="1">
<li><strong><code>sapply</code> Simplifies Iterations</strong>: It’s a useful tool when you want to apply a function to a vector or list and return a simplified result.</li>
<li><strong>Logical Indexing with <code>which</code></strong>: The combination of <code>which</code> and logical conditions (<code>format(dates, "%Y") == year</code>) is a common way to find specific indices in R.</li>
<li><strong>Chaining Steps Together</strong>: This code demonstrates how small functions like <code>format</code>, <code>which</code>, and <code>sapply</code> can be combined to perform complex tasks efficiently.</li>
</ol>
<p>Now let us go on in our task of modelling the SP500 using the binomial lattice model. We comute the log returns in a next step and do the calibration. Not much exciting new things are going on here in terms of R. This code-part should be straightformward.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute annual log returns</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>log_returns <span class="ot">&lt;-</span> <span class="fu">diff</span>(<span class="fu">log</span>(annual_prices))  <span class="co"># Compute log(S_T / S_0)</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine into a data frame</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>annual_log_returns <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">year =</span> <span class="fu">format</span>(annual_dates[<span class="sc">-</span><span class="dv">1</span>], <span class="st">"%Y"</span>),  <span class="co"># Corresponding years for log returns</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">log_return =</span> log_returns</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters for weekly time step (1/52 years)</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Weekly time step</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>delta_t <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">52</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="co">#Mean log return</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>nu <span class="ot">&lt;-</span> <span class="fu">mean</span>(annual_log_returns<span class="sc">$</span>log_return, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Variance</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>sigma_squared <span class="ot">&lt;-</span> <span class="fu">var</span>(annual_log_returns<span class="sc">$</span>log_return, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)  </span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard deviation</span></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(sigma_squared)  </span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Calibrate binomial model parameters</span></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> (nu <span class="sc">/</span> sigma) <span class="sc">*</span> <span class="fu">sqrt</span>(delta_t)</span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">exp</span>(sigma <span class="sc">*</span> <span class="fu">sqrt</span>(delta_t))</span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>sigma <span class="sc">*</span> <span class="fu">sqrt</span>(delta_t))</span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a><span class="co"># View calibrated parameters</span></span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>parameters <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">nu =</span> nu,</span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">sigma =</span> sigma,</span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> p,</span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">u =</span> u,</span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">d =</span> d</span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a>parameters</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$nu
[1] 0.06734655

$sigma
[1] 0.1768331

$p
[1] 0.5264071

$u
[1] 1.024825

$d
[1] 0.9757759</code></pre>
</div>
</div>
<p>We retrieve a series of daily prices, extract a series of annual price changes from there and then compute the parameters and pack them into a list. The precise mathematical reason why we can calibrate the model like this and why this works, we will see in lecture 5.</p>
</section>
<section id="building-the-lattice-for-loops-and-lookup-tables.-1" class="level4" data-number="4.10.2.2">
<h4 data-number="4.10.2.2" class="anchored" data-anchor-id="building-the-lattice-for-loops-and-lookup-tables.-1"><span class="header-section-number">4.10.2.2</span> Building the lattice: For loops and lookup tables.</h4>
<p>We are now going to build the lattice. At this stage let us just take a tiny number of time steps, so we can inspect the output of what we are doing with ease. You can later play for yourself with this code and just increase the value of <span class="math inline">\(n\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the step number</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the starting price S0 (choose most recent price)</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>S0 <span class="ot">&lt;-</span> adjusted_prices[<span class="fu">length</span>(adjusted_prices)]</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the lattice as a list</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>lattice <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, n <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the lattice</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (step <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>n) {</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>  prices <span class="ot">&lt;-</span> <span class="fu">numeric</span>(step <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>step) {</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>    prices[i <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> S0 <span class="sc">*</span> u<span class="sc">^</span>i <span class="sc">*</span> d<span class="sc">^</span>(step <span class="sc">-</span> i)</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>  lattice[[step <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> prices</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a><span class="co"># View the lattice</span></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>lattice</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 586.08

[[2]]
[1] 571.8827 600.6297

[[3]]
[1] 558.0294 586.0800 615.5407

[[4]]
[1] 544.5116 571.8827 600.6297 630.8218</code></pre>
</div>
</div>
<p>This code snippet uses <strong><code>for</code> loops</strong> and a <strong>lookup table</strong> to build a binomial lattice. Both are important concepts when writing R programs-</p>
<p>Let’s break it down step by step, focusing on the programming concepts involved.</p>
<p>A <code>for</code> loop in R iterates over a sequence of values, executing a block of code for each value. Its syntax is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (variable <span class="cf">in</span> sequence) {</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Code to execute in each iteration</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In our code we have two loops: An <em>outer loop</em> <code>for (step in 0:n) {</code>. This loop iterates through each step of the lattice, from <code>0</code> to <code>n</code> (the total number of time steps in the model). The variable <code>step</code> represents the current level of the lattice.</p>
<p>The <em>inner loop</em> <code>for (i in 0:step) {</code>: For each level of the lattice (<code>step</code>), this loop iterates over the possible nodes (prices) at that level. The variable <code>i</code> represents the number of upward moves at this level.</p>
<p>A <strong>lookup table</strong> is a data structure that stores values for quick access, allowing computations to refer to pre-calculated data instead of recomputing it repeatedly.</p>
<p>In this example, the <strong>lattice itself is the lookup table</strong>. It stores the prices at each step and node of the lattice in a list structure:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>  lattice[[step <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> prices</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Each element of <code>lattice</code> corresponds to a time step. <code>lattice[[step + 1]]</code> stores a numeric vector containing all possible prices at the <code>step</code> level of the lattice.</p>
<p>Now here’s how the code uses <code>for</code> loops and a lookup table to build the binomial lattice:</p>
<p>We first initialize the lattice by <code>lattice &lt;- vector("list", n + 1)</code>. A list of size <code>n + 1</code> is created to store the prices for each step of the lattice (from step <code>0</code> to step <code>n</code>). Lists are ideal here because they allow each element to store a vector of prices, with the number of prices varying at each step.</p>
<p>Pre-allocating space for the output is good practice when writing <code>for</code> loops in R (or any other programming language) because it significantly improves performance and readability. Here’s why: It <strong>avoids repeated memory allocation</strong>: If you grow an object inside a loop (e.g., using <code>c()</code> to append values), R reallocates memory every time the object changes size. This is computationally expensive, especially for large loops.</p>
<p>By pre-allocating the required space, memory is allocated only once, and the values are directly written into the reserved space, saving computation time.</p>
<p>Pre-allocation makes the structure of the output clear before the loop begins and <strong>improves code readability</strong>. Readers can immediately understand the size and type of the expected result.</p>
<p>Finally it <strong>avoids unnecessary complexity</strong>: Growing objects dynamically can make the code harder to follow and debug.</p>
<p>Pre-allocation ensures better performance and cleaner, more professional code!</p>
<p>Let’s look a bit closer into what our loops do:</p>
<p>The <strong>Outer Loop</strong> iterates over each step of the lattice. At each step, a new vector <code>prices</code> is created to store the prices for that level.</p>
<p>The <strong>Inner Loop</strong> computes the price for each node at the current step. For node <code>i</code>, the price is calculated using: <span class="math display">\[
S_i = S_0 \cdot u^i \cdot d^{\text{step} - i}
\]</span> The result is stored in the <code>prices</code> vector, with indices adjusted for R’s 1-based indexing (<code>i + 1</code>).</p>
<p>After computing all prices for the current step, the <code>prices</code> vector is added to the <code>lattice</code> lookup table at index <code>step + 1</code>.</p>
<p>The final <code>lattice</code> contains all possible prices at each step, structured as a list: - <code>lattice[[1]]</code>: Prices at step 0 (initial price, <code>S0</code>). - <code>lattice[[2]]</code>: Prices at step 1 (two possible prices: up and down). - And so on, up to <code>lattice[[n + 1]]</code>.</p>
<p>Let us visualize the lattice. This, of course, only makes sense for small nubers of time steps because the lattice grows rapidly as the time steps get bigger. For our visualization here I use the <code>ggplot2</code> library, a great library for visualization of all kinds with a consistent “grammar of graphics”.</p>
<p>Let us prepare the data for our plot first:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for plotting</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Step =</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span>n, <span class="at">times =</span> <span class="fu">seq_len</span>(n <span class="sc">+</span> <span class="dv">1</span>)),  <span class="co"># x-coordinates</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Price =</span> <span class="fu">unlist</span>(lattice),                 <span class="co"># y-coordinates</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Label =</span> <span class="fu">round</span>(<span class="fu">unlist</span>(lattice), <span class="dv">2</span>)        <span class="co"># Labels with rounded prices</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create edges for connections</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="cf">function</span>(step) {</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">rep</span>(step <span class="sc">-</span> <span class="dv">1</span>, <span class="at">times =</span> step),           <span class="co"># Starting x-coordinates</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">xend =</span> <span class="fu">rep</span>(step, <span class="at">times =</span> step),           <span class="co"># Ending x-coordinates</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> lattice[[step]],                      <span class="co"># Starting y-coordinates</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">yend =</span> <span class="fu">c</span>(lattice[[step <span class="sc">+</span> <span class="dv">1</span>]][<span class="sc">-</span><span class="dv">1</span>], lattice[[step <span class="sc">+</span> <span class="dv">1</span>]][<span class="sc">-</span><span class="fu">length</span>(lattice[[step <span class="sc">+</span> <span class="dv">1</span>]])]) <span class="co"># Ending y-coordinates</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>}))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This part of the code needs some explanation:</p>
<p>The code prepares two main components: data for plotting the nodes (prices at each step) and data for connecting those nodes with edges (showing transitions between prices).</p>
<p>To prepare the nodes, we create a <code>data.frame</code> for the lattice’s nodes, which represent the prices at each step in the lattice.</p>
<ol type="1">
<li><p><code>Step</code> (x-coordinates):</p>
<ul>
<li><code>rep(0:n, times = seq_len(n + 1))</code> creates a vector repeating each step number (<code>0:n</code>) a specific number of times.</li>
<li><code>seq_len(n + 1)</code> generates the sequence of repetitions: <code>1, 2, 3, ..., n + 1</code>. This ensures that:
<ul>
<li>At step 0, there’s 1 node.</li>
<li>At step 1, there are 2 nodes.</li>
<li>At step 2, there are 3 nodes, and so on.</li>
</ul></li>
<li>Example for <code>n = 2</code>: <code>Step = c(0, 1, 1, 2, 2, 2)</code>.</li>
</ul></li>
<li><p><code>Price</code> (y-coordinates):</p>
<ul>
<li><code>unlist(lattice)</code> flattens the list <code>lattice</code> into a single vector.</li>
<li><code>lattice</code> is assumed to be a list where each element corresponds to the prices (y-coordinates) at a specific step in the lattice.</li>
<li>For instance, if <code>lattice = list(c(100), c(110, 90), c(121, 100, 81))</code>, then <code>unlist(lattice)</code> produces <code>c(100, 110, 90, 121, 100, 81)</code>.</li>
</ul></li>
<li><p><code>Label</code>:</p>
<ul>
<li><code>round(unlist(lattice), 2)</code> creates rounded labels for the prices, suitable for display in a plot.</li>
</ul></li>
</ol>
<p>The resulting <code>data.frame</code> contains three columns:</p>
<ul>
<li><code>Step</code>: The x-coordinate (time step).</li>
<li><code>Price</code>: The y-coordinate (price value).</li>
<li><code>Label</code>: Rounded price values for display.</li>
</ul>
<p>To create the edges we need to prepare the connections between nodes, which represent the transitions between prices at consecutive steps. Here is what is going on</p>
<ol type="1">
<li><p>Outer Loop with <code>lapply</code>:</p>
<ul>
<li>Loops over each step (<code>1:n</code>) in the lattice. For each step:
<ul>
<li>Connections are created between the nodes at the current step (<code>step - 1</code>) and the next step (<code>step</code>).</li>
</ul></li>
</ul></li>
<li><p>Starting Coordinates (<code>x</code>, <code>y</code>):</p>
<ul>
<li><code>x</code>: <code>rep(step - 1, times = step)</code> sets the starting x-coordinate for all connections at step <code>step</code>.
<ul>
<li>E.g., for step 1, <code>x = rep(0, 1)</code>; for step 2, <code>x = rep(1, 2)</code>.</li>
</ul></li>
<li><code>y</code>: <code>lattice[[step]]</code> provides the y-coordinates (prices) of the starting nodes.</li>
</ul></li>
<li><p>Ending Coordinates (<code>xend</code>, <code>yend</code>):</p>
<ul>
<li><code>xend</code>: <code>rep(step, times = step)</code> sets the ending x-coordinate for all connections at the next step.</li>
<li><code>yend</code>: The tricky part! It selects the y-coordinates of the ending nodes:
<ul>
<li><code>lattice[[step + 1]][-1]</code>: Removes the first price at the next step.</li>
<li><code>lattice[[step + 1]][-length(lattice[[step + 1]])]</code>: Removes the last price at the next step.</li>
<li>Combined using <code>c(...)</code> to connect prices at step <code>step</code> to both upward and downward transitions at step <code>step + 1</code>.</li>
</ul></li>
</ul></li>
<li><p><strong><code>do.call(rbind, ...)</code>:</strong></p>
<ul>
<li>Combines all the individual <code>data.frame</code> objects (one per step) into a single <code>data.frame</code> with the connection data.</li>
</ul></li>
</ol>
<p>The resulting <code>edges</code> <code>data.frame</code> has four columns:</p>
<ul>
<li><code>x</code>: Starting x-coordinates.</li>
<li><code>xend</code>: Ending x-coordinates.</li>
<li><code>y</code>: Starting y-coordinates.</li>
<li><code>yend</code>: Ending y-coordinates.</li>
</ul>
<p>This is a good opprotubity for <strong>understanding <code>lapply</code> and <code>do.call</code>:</strong></p>
<ul>
<li><code>lapply</code> applies a function to each element of a sequence (steps here) and returns a list of results.</li>
<li><code>do.call(rbind, ...)</code> merges the list of <code>data.frame</code>s into a single <code>data.frame</code>.</li>
</ul>
<p>Now we can do our visualization:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load ggplot2 library</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add edges</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">data =</span> edges, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend),</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> <span class="st">"gray"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add nodes</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> plot_data, <span class="fu">aes</span>(<span class="at">x =</span> Step, <span class="at">y =</span> Price), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add price labels</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> plot_data, <span class="fu">aes</span>(<span class="at">x =</span> Step, <span class="at">y =</span> Price, <span class="at">label =</span> Label),</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Enriched Binomial Lattice with Prices for S&amp;P 500"</span>,</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Step"</span>, <span class="at">y =</span> <span class="st">"Price"</span>) <span class="sc">+</span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04-lecture4_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Before we go through the syntax of this code snippet let me first briefly introduce you to the logic of <code>ggplot2</code></p>
<p>The <strong><code>ggplot2</code></strong> package is one of the most popular tools in R for creating visualizations. It uses a <strong>layered grammar of graphics</strong>, which means you build a plot step-by-step by adding layers. Each layer corresponds to a specific aspect of the visualization, such as:</p>
<ol type="1">
<li><strong>The Data:</strong> Define the dataset you want to visualize.</li>
<li><strong>Aesthetic Mappings (<code>aes</code>)</strong>: Specify how variables in your data map to visual properties (e.g., x/y positions, colors, sizes).</li>
<li><strong>Geometries (<code>geom_</code>)</strong>: Add geometric objects like points, lines, or bars to represent the data visually.</li>
<li><strong>Themes and Labels:</strong> Customize the look of the plot (theme) and annotate it with titles, axis labels, etc.</li>
</ol>
<p>With this understanding, let’s break down the provided code.</p>
<hr>
</section>
</section>
<section id="the-code-building-a-binomial-lattice-plot-1" class="level3" data-number="4.10.3">
<h3 data-number="4.10.3" class="anchored" data-anchor-id="the-code-building-a-binomial-lattice-plot-1"><span class="header-section-number">4.10.3</span> The Code: Building a Binomial Lattice Plot</h3>
<p>We first create a plot base through <code>ggplot() +</code>:</p>
<ul>
<li>This initializes an empty plot. The <code>ggplot()</code> function can take a dataset as its argument, but in this case, it’s left empty because the plot will use multiple datasets (<code>edges</code> and <code>plot_data</code>) added in later layers.</li>
</ul>
<p>In the next step we add edges by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_segment</span>(<span class="at">data =</span> edges, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend),</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"gray"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p><code>geom_segment</code>: This geometry adds line segments (edges) to the plot. Each segment connects a starting point <code>(x, y)</code> to an ending point <code>(xend, yend)</code>.</p></li>
<li><p><code>data = edges</code>: Specifies that this layer uses the <code>edges</code> dataset, which contains the start and end coordinates of each edge.</p></li>
<li><p><code>aes(x = x, y = y, xend = xend, yend = yend)</code>: Maps the start (<code>x</code>, <code>y</code>) and end (<code>xend</code>, <code>yend</code>) points for the edges from the <code>edges</code> dataset.</p></li>
<li><p>Styling:</p>
<ul>
<li><code>color = "gray"</code> makes the edges gray.</li>
<li><code>linetype = "dashed"</code> creates dashed lines to distinguish the edges visually.</li>
</ul></li>
</ul>
<p>Now we add nodes by evoking:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_point</span>(<span class="at">data =</span> plot_data, <span class="fu">aes</span>(<span class="at">x =</span> Step, <span class="at">y =</span> Price), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p><code>geom_point</code>: This geometry adds points (nodes) to the plot.</p></li>
<li><p><code>data = plot_data</code>: Specifies the dataset containing node information.</p></li>
<li><p><code>aes(x = Step, y = Price)</code>: Maps the <code>Step</code> (x-axis) and <code>Price</code> (y-axis) variables from the <code>plot_data</code> dataset.</p></li>
<li><p>Styling:</p>
<ul>
<li><code>color = "blue"</code> sets the points’ color.</li>
<li><code>size = 2</code> adjusts the size of the points to make them visible but not overpowering.</li>
</ul></li>
</ul>
<p>Nex we add price labels by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_text</span>(<span class="at">data =</span> plot_data, <span class="fu">aes</span>(<span class="at">x =</span> Step, <span class="at">y =</span> Price, <span class="at">label =</span> Label),</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p><code>geom_text</code>: This geometry adds text labels to the plot.</p></li>
<li><p><code>data = plot_data</code>: Uses the same dataset as the nodes, since labels correspond to the nodes.</p></li>
<li><p><code>aes(x = Step, y = Price, label = Label)</code>:</p>
<ul>
<li><p><code>x = Step</code> and <code>y = Price</code> position the labels at the nodes.</p></li>
<li><p><code>label = Label</code> specifies the text to display, which is the rounded price values from the <code>Label</code> column.</p></li>
</ul></li>
<li><p>Styling:</p>
<ul>
<li><p><code>color = "black"</code> sets the text color.</p></li>
<li><p><code>vjust = -0.5</code> adjusts the vertical alignment of the labels so they appear slightly above the nodes.</p></li>
<li><p><code>size = 3</code> adjusts the font size.</p></li>
</ul></li>
</ul>
<p>Finally we define the plot lables and add the <code>minimal</code>theme from the library of themes provided by <code>ggplot2</code>.</p>
<p>The resulting plot will look like:</p>
<ul>
<li><p><strong>A binomial lattice</strong> with:</p>
<ul>
<li><p>Dashed gray edges connecting nodes, representing the upward and downward transitions.</p></li>
<li><p>Blue points for each node in the lattice, representing prices at different steps.</p></li>
<li><p>Black text labels above the nodes, displaying the rounded price values.</p></li>
<li><p>A clean and minimal design with a title and labeled axes.</p></li>
</ul></li>
</ul>
<p>This code demonstrates how to layer multiple datasets (nodes and edges) in a single visualization using <code>ggplot2</code>. By carefully controlling each layer and its aesthetic mappings, you can create complex and informative visualizations.</p>
<section id="exploring-the-lattice-flow-control-1" class="level4" data-number="4.10.3.1">
<h4 data-number="4.10.3.1" class="anchored" data-anchor-id="exploring-the-lattice-flow-control-1"><span class="header-section-number">4.10.3.1</span> Exploring the Lattice: Flow Control</h4>
<p>We can now use our lattice to demonstrate some other R programing tools. Let us explore the lattice by using <code>while</code>loops to traverse the lattice and compute specific properties (e.g., maximum or minimum price).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Traverse lattice to find maximum price</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>max_price <span class="ot">&lt;-</span> <span class="sc">-</span><span class="cn">Inf</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>step <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (step <span class="sc">&lt;=</span> <span class="fu">length</span>(lattice)) {</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  max_price <span class="ot">&lt;-</span> <span class="fu">max</span>(max_price, <span class="fu">max</span>(lattice[[step]]))</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  step <span class="ot">&lt;-</span> step <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>max_price</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 630.8218</code></pre>
</div>
</div>
<p>This code traverses through a <strong>binomial lattice</strong> (stored as a list of price vectors) to find the <strong>maximum price</strong> across all steps. Along the way, it introduces the concept of an R <code>while</code> loop, which is a fundamental control structure used for iterative computations.</p>
<p>We first initialize the variables <code>max_price</code> and <code>step</code>-</p>
<ul>
<li><code>max_price</code>: This variable keeps track of the maximum price found so far.
<ul>
<li>It is initialized to <code>-Inf</code> (negative infinity) because any price in the lattice will be greater than this value, ensuring the first price comparison updates it.</li>
</ul></li>
<li><code>step</code>: This variable represents the current step (or level) of the lattice being processed. It starts at <code>1</code> to access the first step in the lattice.</li>
</ul>
<p>In R, <strong><code>Inf</code></strong> (infinity) and <strong><code>-Inf</code></strong> (negative infinity) are special numeric constants that represent values beyond the largest or smallest numbers R can handle. They are used in mathematical operations and comparisons where results exceed the limits of finite numbers.</p>
<p><code>Inf</code> is larger than any finite number, and <code>-Inf</code> is smaller than any finite number. <code>Inf</code> and <code>-Inf</code> are commonly used as initial values in iterative algorithms. For example:</p>
<ul>
<li><p><code>max_price &lt;- -Inf</code> ensures any number compared to it will update the value.</p></li>
<li><p><code>min_price &lt;- Inf</code> works similarly for finding the smallest value.</p></li>
</ul>
<p>After this short excursion into <code>Inf</code> and <code>-Inf</code> in R we now come to the step where we transverse the lattice using a <code>while</code>loop.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (step <span class="sc">&lt;=</span> <span class="fu">length</span>(lattice)) {</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  max_price <span class="ot">&lt;-</span> <span class="fu">max</span>(max_price, <span class="fu">max</span>(lattice[[step]]))</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  step <span class="ot">&lt;-</span> step <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here are the key Concepts of a <code>while</code> Loop:</p>
<ul>
<li>A <code>while</code> loop repeats a block of code <strong>as long as the condition remains <code>TRUE</code></strong>.</li>
<li>It’s useful when the number of iterations isn’t predetermined and depends on a condition being met.</li>
</ul>
<p>Here’s how it works in this snippet:</p>
<ol type="1">
<li><p>Condition (<code>step &lt;= length(lattice)</code>):</p>
<ul>
<li>The loop continues as long as <code>step</code> is less than or equal to the number of steps in the lattice (<code>length(lattice)</code>).</li>
<li>This ensures every level of the lattice is checked.</li>
</ul></li>
<li><p>Update Maximum Price:</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>   max_price <span class="ot">&lt;-</span> <span class="fu">max</span>(max_price, <span class="fu">max</span>(lattice[[step]]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><code>lattice[[step]]</code>: Accesses the vector of prices at the current step.</li>
<li><code>max(lattice[[step]])</code>: Finds the maximum price at the current step.</li>
<li><code>max(max_price, ...)</code>: Updates <code>max_price</code> with the larger value between the current <code>max_price</code> and the maximum price at the current step.</li>
</ul>
<ol start="3" type="1">
<li>The expression <code>step &lt;- step + 1</code> is the so called **increment <code>step</code>: After processing the current step, the <code>step</code> variable is increased by 1 to move to the next step in the lattice.</li>
</ol>
<p>After the loop completes, <code>max_price</code> contains the maximum price found across all steps of the lattice.</p>
<p>The <strong>General Structure of a <code>while</code> Loop:</strong> is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>   <span class="cf">while</span> (condition) {</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>       <span class="co"># Code block to execute</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>   }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>The loop runs as long as the <code>condition</code> evaluates to <code>TRUE</code>.</li>
<li>You must ensure the condition eventually becomes <code>FALSE</code>; otherwise, the loop will run indefinitely (infinite loop).</li>
</ul>
<p>The key Features in our example:</p>
<ul>
<li><strong>Initialization:</strong> Variables (<code>max_price</code>, <code>step</code>) are set up before the loop.</li>
<li><strong>Condition Check:</strong> The loop continues as long as <code>step &lt;= length(lattice)</code>.</li>
<li><strong>Update Mechanism:</strong> Both <code>max_price</code> and <code>step</code> are updated within the loop, ensuring progress toward termination.</li>
</ul>
<p>The common use case for while loops are:</p>
<ul>
<li>When the number of iterations isn’t known beforehand (e.g., processing until a condition is met).</li>
<li>Traversing a list or dataset, as in this example.</li>
</ul>
<p>It is best practice to:</p>
<ul>
<li>Always ensure the condition can eventually become <code>FALSE</code>.</li>
<li>Use <code>print</code> or <code>cat</code> statements inside the loop to debug and see intermediate results.</li>
</ul>
</section>
<section id="does-the-price-exceed-a-threshold-conditional-statements-to-annotate-whether-a-price-exceeds-a-certain-threshold.-1" class="level4" data-number="4.10.3.2">
<h4 data-number="4.10.3.2" class="anchored" data-anchor-id="does-the-price-exceed-a-threshold-conditional-statements-to-annotate-whether-a-price-exceeds-a-certain-threshold.-1"><span class="header-section-number">4.10.3.2</span> Does the price exceed a threshold?: Conditional statements to annotate whether a price exceeds a certain threshold.</h4>
<p>Let’s consider next this codes snippet. It helps us finding out whether a price in the lattice exceeds a particular threshold. This is a question you will ask yourself often when analyzing options, for example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Annotate prices exceeding 4100</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>threshold <span class="ot">&lt;-</span> <span class="dv">4100</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (step <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>n) {</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(lattice[[step <span class="sc">+</span> <span class="dv">1</span>]])) {</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (lattice[[step <span class="sc">+</span> <span class="dv">1</span>]][i] <span class="sc">&gt;</span> threshold) {</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Price exceeds threshold at step"</span>, step, <span class="st">":"</span>, lattice[[step <span class="sc">+</span> <span class="dv">1</span>]][i]))</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This code snippet traverses the <strong>binomial lattice</strong> (stored as a list of price vectors) to identify and print prices exceeding a given threshold (<code>4100</code>). It uses <strong>nested <code>for</code> loops</strong> to navigate through the lattice and an <strong><code>if</code> conditional statement</strong> to check whether each price exceeds the threshold.</p>
<p>In the beginning we define our threshold by <code>threshold &lt;- 4100</code>. Any price greater than this value will trigger a message.</p>
<p>We have an outer loop</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (step <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>n) {</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>The <code>for</code> loop iterates over the steps of the lattice, from <code>0</code> (the initial step) to <code>n</code> (the final step).</li>
<li>Each <code>step</code> represents a time period or level in the lattice.</li>
</ul>
<p>We also have an inner loop to traverse prices within each step, which is in the code segment</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(lattice[[step <span class="sc">+</span> <span class="dv">1</span>]])) {</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><code>lattice[[step + 1]]</code>:
<ul>
<li>Accesses the list element for the current step (<code>step + 1</code> because R uses 1-based indexing).</li>
<li>This element is a vector of prices at the given step.</li>
</ul></li>
<li><code>seq_along(...)</code>:
<ul>
<li>Creates a sequence from <code>1</code> to the length of <code>lattice[[step + 1]]</code>.</li>
<li>This ensures that every price in the current step is checked.</li>
</ul></li>
<li>The <code>i</code> variable is the index of a price in the vector <code>lattice[[step + 1]]</code>.</li>
</ul>
<p>Now comes a new concept: A <strong>conditional statement</strong> to check the threshold:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (lattice[[step <span class="sc">+</span> <span class="dv">1</span>]][i] <span class="sc">&gt;</span> threshold) {</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Price exceeds threshold at step"</span>, step, <span class="st">":"</span>, lattice[[step <span class="sc">+</span> <span class="dv">1</span>]][i]))</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let me explain the syntax of the if statment in R:</p>
<ul>
<li>Condition:<code>lattice[[step + 1]][i] &gt; threshold</code>
<ul>
<li>Checks whether the price at index <code>i</code> in the current step is greater than the threshold.</li>
</ul></li>
<li>If the condition evaluates to <code>TRUE</code>:
<ul>
<li>Executes the code inside the curly braces <code>{...}</code>.</li>
<li>In this case, it prints a message containing:
<ul>
<li>The <code>step</code> number.</li>
<li>The price (<code>lattice[[step + 1]][i]</code>) that exceeds the threshold.</li>
</ul></li>
</ul></li>
</ul>
<p>When Condition is <code>FALSE</code>: If the condition evaluates to <code>FALSE</code> (price does not exceed the threshold), the code inside the braces is skipped.</p>
<p>The general structure of an <code>if</code> statement in R is</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (condition) {</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Code to execute if condition is TRUE</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p><code>condition</code>:</p>
<ul>
<li><p>A logical expression that evaluates to <code>TRUE</code> or <code>FALSE</code>.</p></li>
<li><p>Can involve comparisons (<code>&gt;</code>, <code>&lt;</code>, <code>==</code>, <code>!=</code>, etc.), logical operators (<code>&amp;</code>, <code>|</code>, <code>!</code>), or built-in R functions.</p></li>
</ul></li>
<li><p>If the <code>condition</code> is <code>TRUE</code>, the code block inside <code>{}</code> is executed.</p></li>
<li><p>If the <code>condition</code> is <code>FALSE</code>, the code block is skipped.</p></li>
</ul>
<p>You always have the option to extend a conditional statement by an <code>else</code> block:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (condition) {</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Code to execute if condition is TRUE</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Code to execute if condition is FALSE</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="writing-modular-code-reusable-functions-for-the-binomial-lattice" class="level3" data-number="4.10.4">
<h3 data-number="4.10.4" class="anchored" data-anchor-id="writing-modular-code-reusable-functions-for-the-binomial-lattice"><span class="header-section-number">4.10.4</span> Writing Modular Code: Reusable Functions for the Binomial Lattice</h3>
<p>In programming, modularity refers to the practice of dividing your code into smaller, reusable, and independent pieces—typically functions—that can be composed to solve complex problems. Modularity enhances readability, maintainability, and reusability, making your code more professional and easier to debug or extend.</p>
<p>Let’s refactor the code we’ve written so far into a set of modular functions, demonstrating how this principle can be applied to our binomial lattice model.</p>
<p>Why should we write our programs in a modular way? Here are four strong reasons:</p>
<ol type="1">
<li><strong>Clarity</strong>: Breaking code into smaller, well-named functions makes the logic easier to follow.</li>
<li><strong>Reusability</strong>: Functions can be reused across different projects or scenarios without rewriting the code.</li>
<li><strong>Debugging</strong>: Errors can be isolated to specific functions, simplifying the debugging process.</li>
<li><strong>Testing</strong>: Individual functions can be tested independently, ensuring correctness of each part.</li>
</ol>
<p>Let us demonstrate this approach by refactoring code we have written so far.</p>
<p>We will write the following functions:</p>
<ol type="1">
<li><strong><code>calibrate_parameters</code></strong>: Calibrate the binomial lattice parameters from data.</li>
<li><strong><code>build_lattice</code></strong>: Construct the binomial lattice using calibrated parameters.</li>
<li><strong><code>plot_lattice</code></strong>: Visualize the lattice using <code>ggplot2</code>.</li>
<li><strong><code>explore_lattice</code></strong>: Analyze properties of the lattice, such as maximum price or threshold crossings.</li>
</ol>
<section id="calibrating-parameters" class="level4" data-number="4.10.4.1">
<h4 data-number="4.10.4.1" class="anchored" data-anchor-id="calibrating-parameters"><span class="header-section-number">4.10.4.1</span> Calibrating Parameters</h4>
<p>We begin with a function to compute the lattice parameters from stock price data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>calibrate_parameters <span class="ot">&lt;-</span> <span class="cf">function</span>(annual_prices, delta_t) {</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  log_returns <span class="ot">&lt;-</span> <span class="fu">diff</span>(<span class="fu">log</span>(annual_prices))</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate mean and variance</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  nu <span class="ot">&lt;-</span> <span class="fu">mean</span>(log_returns, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>  sigma_squared <span class="ot">&lt;-</span> <span class="fu">var</span>(log_returns, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>  sigma <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(sigma_squared)</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calibrate parameters</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> (nu <span class="sc">/</span> sigma) <span class="sc">*</span> <span class="fu">sqrt</span>(delta_t)</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>  u <span class="ot">&lt;-</span> <span class="fu">exp</span>(sigma <span class="sc">*</span> <span class="fu">sqrt</span>(delta_t))</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>sigma <span class="sc">*</span> <span class="fu">sqrt</span>(delta_t))</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">nu =</span> nu, <span class="at">sigma =</span> sigma, <span class="at">p =</span> p, <span class="at">u =</span> u, <span class="at">d =</span> d)</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This function takes annual prices and a time step (<code>delta_t</code>) as inputs and returns a list of calibrated parameters. It encapsulates the parameter calibration logic, making it reusable for different assets or time frames.</p>
</section>
<section id="building-the-lattice" class="level4" data-number="4.10.4.2">
<h4 data-number="4.10.4.2" class="anchored" data-anchor-id="building-the-lattice"><span class="header-section-number">4.10.4.2</span> Building the Lattice</h4>
<p>Next, we encapsulate the lattice construction process into a reusable function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>build_lattice <span class="ot">&lt;-</span> <span class="cf">function</span>(S0, n, u, d) {</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  lattice <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, n <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (step <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>n) {</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    prices <span class="ot">&lt;-</span> <span class="fu">numeric</span>(step <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>step) {</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>      prices[i <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> S0 <span class="sc">*</span> u<span class="sc">^</span>i <span class="sc">*</span> d<span class="sc">^</span>(step <span class="sc">-</span> i)</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>    lattice[[step <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> prices</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>  lattice</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This function constructs the lattice for a given starting price (<code>S0</code>), number of steps (<code>n</code>), and parameters <code>u</code> and <code>d</code>. It returns the lattice as a list of price vectors.</p>
</section>
<section id="visualizing-the-lattice" class="level4" data-number="4.10.4.3">
<h4 data-number="4.10.4.3" class="anchored" data-anchor-id="visualizing-the-lattice"><span class="header-section-number">4.10.4.3</span> 3. Visualizing the lattice</h4>
<p>Visualization can also be modularized into a dedicated function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>plot_lattice <span class="ot">&lt;-</span> <span class="cf">function</span>(lattice) {</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(lattice) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Prepare data for plotting</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>  plot_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Step =</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span>n, <span class="at">times =</span> <span class="fu">seq_len</span>(n <span class="sc">+</span> <span class="dv">1</span>)),</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">Price =</span> <span class="fu">unlist</span>(lattice),</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Label =</span> <span class="fu">round</span>(<span class="fu">unlist</span>(lattice), <span class="dv">2</span>)</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>  edges <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="cf">function</span>(step) {</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">rep</span>(step <span class="sc">-</span> <span class="dv">1</span>, <span class="at">times =</span> step),</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">xend =</span> <span class="fu">rep</span>(step, <span class="at">times =</span> step),</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> lattice[[step]],</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">yend =</span> <span class="fu">c</span>(lattice[[step <span class="sc">+</span> <span class="dv">1</span>]][<span class="sc">-</span><span class="dv">1</span>], lattice[[step <span class="sc">+</span> <span class="dv">1</span>]][<span class="sc">-</span><span class="fu">length</span>(lattice[[step <span class="sc">+</span> <span class="dv">1</span>]])])</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_segment</span>(<span class="at">data =</span> edges, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend),</span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a>                          <span class="at">color =</span> <span class="st">"gray"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">data =</span> plot_data, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> Step, <span class="at">y =</span> Price), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(<span class="at">data =</span> plot_data, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> Step, <span class="at">y =</span> Price, <span class="at">label =</span> Label),</span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Binomial Lattice"</span>, <span class="at">x =</span> <span class="st">"Step"</span>, <span class="at">y =</span> <span class="st">"Price"</span>) <span class="sc">+</span></span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_minimal</span>()</span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This function accepts the lattice and produces a visualization using <code>ggplot2</code>. Note that in this function I use explicit name spaces for the ggplot2 package rather than loading the package by the <code>library()</code>command. The syntax in R is <code>package_name::function_from_package</code>. This allows you to call a function from a package you have already installed without the necessity to load the package via library.</p>
<p>This approach is particularly valuable for:</p>
<ul>
<li>Writing standalone functions (like in this case).</li>
<li>Sharing code in packages or scripts where dependencies may not be preloaded.</li>
<li>Avoiding confusion when using multiple packages with overlapping function names (e.g., dplyr::filter vs.&nbsp;stats::filter).</li>
</ul>
</section>
<section id="exploring-the-lattice" class="level4" data-number="4.10.4.4">
<h4 data-number="4.10.4.4" class="anchored" data-anchor-id="exploring-the-lattice"><span class="header-section-number">4.10.4.4</span> Exploring the Lattice</h4>
<p>We can write modular functions for common exploratory tasks, such as finding the maximum price or checking for threshold crossings:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>find_max_price <span class="ot">&lt;-</span> <span class="cf">function</span>(lattice) {</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  max_price <span class="ot">&lt;-</span> <span class="sc">-</span><span class="cn">Inf</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (step <span class="cf">in</span> <span class="fu">seq_along</span>(lattice)) {</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    max_price <span class="ot">&lt;-</span> <span class="fu">max</span>(max_price, <span class="fu">max</span>(lattice[[step]]))</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>  max_price</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>check_threshold <span class="ot">&lt;-</span> <span class="cf">function</span>(lattice, threshold) {</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (step <span class="cf">in</span> <span class="fu">seq_along</span>(lattice)) {</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (price <span class="cf">in</span> lattice[[step]]) {</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (price <span class="sc">&gt;</span> threshold) {</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Price exceeds threshold at step"</span>, step <span class="sc">-</span> <span class="dv">1</span>, <span class="st">":"</span>, price))</span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These functions encapsulate specific analytical tasks, making them easy to reuse or adapt.</p>
</section>
<section id="putting-it-all-together" class="level4" data-number="4.10.4.5">
<h4 data-number="4.10.4.5" class="anchored" data-anchor-id="putting-it-all-together"><span class="header-section-number">4.10.4.5</span> Putting It All Together</h4>
<p>Here’s how you could use these modular functions in practice:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calibrate parameters</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>parameters <span class="ot">&lt;-</span> <span class="fu">calibrate_parameters</span>(annual_prices, <span class="at">delta_t =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">52</span>)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the lattice</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>lattice <span class="ot">&lt;-</span> <span class="fu">build_lattice</span>(<span class="at">S0 =</span> adjusted_prices[<span class="fu">length</span>(adjusted_prices)], </span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">n =</span> <span class="dv">5</span>, </span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>                         <span class="at">u =</span> parameters<span class="sc">$</span>u, </span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">d =</span> parameters<span class="sc">$</span>d)</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the lattice</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_lattice</span>(lattice)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04-lecture4_files/figure-html/unnamed-chunk-63-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Explore the lattice</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>max_price <span class="ot">&lt;-</span> <span class="fu">find_max_price</span>(lattice)</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Maximum price in the lattice:"</span>, max_price, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Maximum price in the lattice: 662.5315 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">check_threshold</span>(lattice, <span class="at">threshold =</span> <span class="dv">4100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>By structuring the program into modular functions, the overall workflow becomes more intuitive and maintainable. The binomial lattice model provides a rich framework to demonstrate not just R programming concepts but also best practices for writing clean, reusable code.</p>
</section>
</section>
<section id="further-step-creating-a-package-for-the-binomial-lattice-model" class="level3" data-number="4.10.5">
<h3 data-number="4.10.5" class="anchored" data-anchor-id="further-step-creating-a-package-for-the-binomial-lattice-model"><span class="header-section-number">4.10.5</span> Further Step: Creating a Package for the Binomial Lattice Model</h3>
<p>As you progress in your programming journey, you’ll often find yourself writing multiple functions for a specific task or model, such as the binomial lattice. A valuable next step would be to <strong>collect these functions into an R package</strong>, making them reusable and shareable with others.</p>
<p>An R package provides a structured way to organize your functions, documentation, and even datasets. By packaging your functions for the binomial lattice model, you can streamline your workflow, enhance collaboration, and ensure consistency in your work.</p>
<p>For example, your package could include:</p>
<ul>
<li>Functions for parameter calibration (<code>calibrate_parameters</code>),</li>
<li>Functions for lattice construction (<code>build_lattice</code>),</li>
<li>Functions for visualization (<code>plot_lattice</code>), and</li>
<li>Analytical tools (e.g., <code>find_max_price</code>, <code>check_threshold</code>).</li>
</ul>
<p>Creating a package may seem like a big step, but it builds on the concepts you’ve already learned. It’s an excellent way to deepen your understanding of R programming and software development practices.</p>
<p>To learn more about writing R packages, I highly recommend the book <span class="citation" data-cites="WickhamBryan2023">Wickham and Bryan (<a href="06-references.html#ref-WickhamBryan2023" role="doc-biblioref">2023</a>)</span>. This book provides a comprehensive, step-by-step guide to creating and managing R packages, covering topics such as:</p>
<ul>
<li>Setting up the package structure,</li>
<li>Writing documentation with <code>roxygen2</code>,</li>
<li>Adding tests to ensure your functions work correctly,</li>
<li>Publishing your package on platforms like GitHub or CRAN.</li>
</ul>
<p>Although creating a package is beyond the scope of this lecture, it’s an exciting area to explore as you gain confidence in programming. For now, focus on writing clean, modular functions, as these are the building blocks of any great R package!</p>
</section>
<section id="using-an-llm-to-assist-in-developing-more-complex-programs" class="level3" data-number="4.10.6">
<h3 data-number="4.10.6" class="anchored" data-anchor-id="using-an-llm-to-assist-in-developing-more-complex-programs"><span class="header-section-number">4.10.6</span> Using an LLM to Assist in Developing More Complex Programs</h3>
<p>Leveraging a large language model (LLM) like ChatGPT can be a powerful tool when working on more complex programming tasks, such as developing the binomial lattice model or even creating an R package. Here are some important considerations and tips to help you make the most of this resource:</p>
<section id="break-down-your-problem" class="level4" data-number="4.10.6.1">
<h4 data-number="4.10.6.1" class="anchored" data-anchor-id="break-down-your-problem"><span class="header-section-number">4.10.6.1</span> Break Down Your Problem</h4>
<p>Before asking an LLM for help, clearly define the specific task or problem you’re trying to solve. For example:</p>
<ul>
<li>“How do I implement a <code>while</code> loop to traverse a list in R?”</li>
<li>“What is the best way to structure a function for parameter calibration?”</li>
<li>“How can I generate a plot for the binomial lattice using <code>ggplot2</code>?”</li>
</ul>
<p>Providing clear, concise prompts allows the LLM to generate more relevant and accurate responses.</p>
</section>
<section id="use-llms-for-code-suggestions" class="level4" data-number="4.10.6.2">
<h4 data-number="4.10.6.2" class="anchored" data-anchor-id="use-llms-for-code-suggestions"><span class="header-section-number">4.10.6.2</span> Use LLMs for Code Suggestions</h4>
<p>LLMs are excellent at generating code snippets, but it’s important to review and test the code they provide. For instance:</p>
<ul>
<li>Ask for an example function to implement a specific part of your program, such as lattice visualization.</li>
<li>Request explanations of unfamiliar functions or libraries.</li>
</ul>
<p>For example, you could ask: <em>“How do I use <code>sapply</code> to iterate over a list and calculate a result for each element?”</em></p>
</section>
<section id="seek-explanations-and-debugging-help" class="level4" data-number="4.10.6.3">
<h4 data-number="4.10.6.3" class="anchored" data-anchor-id="seek-explanations-and-debugging-help"><span class="header-section-number">4.10.6.3</span> Seek Explanations and Debugging Help</h4>
<p>If you encounter errors or unexpected behavior, LLMs can help you debug by:</p>
<ul>
<li>Explaining error messages.</li>
<li>Suggesting ways to fix common issues.</li>
<li>Providing step-by-step walkthroughs of the problematic part of your code.</li>
</ul>
<p>For example: <em>“Why am I getting an error when using <code>geom_segment</code> in <code>ggplot2</code>?”</em></p>
</section>
<section id="ask-for-best-practices" class="level4" data-number="4.10.6.4">
<h4 data-number="4.10.6.4" class="anchored" data-anchor-id="ask-for-best-practices"><span class="header-section-number">4.10.6.4</span> Ask for Best Practices</h4>
<p>LLMs can provide insights into programming best practices, such as:</p>
<ul>
<li>Writing modular and reusable code.</li>
<li>Improving code readability.</li>
<li>Using proper function naming and documentation.</li>
</ul>
<p>You might ask: <em>“What are some best practices for writing a reusable R function?”</em></p>
</section>
<section id="learn-from-explanations" class="level4" data-number="4.10.6.5">
<h4 data-number="4.10.6.5" class="anchored" data-anchor-id="learn-from-explanations"><span class="header-section-number">4.10.6.5</span> Learn from Explanations</h4>
<p>When the LLM generates code, ask for an explanation of how the code works if something isn’t clear. For example: <em>“Can you explain how the <code>seq_along</code> function is used in this loop?”</em></p>
<p>This turns the interaction into a learning experience and helps deepen your understanding of programming concepts.</p>
</section>
<section id="iterate-with-feedback" class="level4" data-number="4.10.6.6">
<h4 data-number="4.10.6.6" class="anchored" data-anchor-id="iterate-with-feedback"><span class="header-section-number">4.10.6.6</span> Iterate with Feedback</h4>
<p>Use the LLM interactively:</p>
<ul>
<li>Start with a basic question or request.</li>
<li>Review the response, then refine your query based on what you need next.</li>
<li>Provide feedback, such as clarifying your goals or specifying the context.</li>
</ul>
<p>For example: <em>“I like this function, but could you add error handling for invalid inputs?”</em></p>
</section>
<section id="stay-mindful-of-limitations" class="level4" data-number="4.10.6.7">
<h4 data-number="4.10.6.7" class="anchored" data-anchor-id="stay-mindful-of-limitations"><span class="header-section-number">4.10.6.7</span> Stay Mindful of Limitations</h4>
<p>While LLMs are powerful, they aren’t perfect. Keep these limitations in mind:</p>
<ul>
<li>They might generate syntactically correct code that doesn’t solve your specific problem.</li>
<li>They may not fully understand the broader context of your program.</li>
<li>They can occasionally provide outdated or suboptimal solutions.</li>
</ul>
<p>Always validate the code provided, and cross-check important suggestions with reliable documentation or resources.</p>
</section>
<section id="use-llms-as-a-collaborative-partner" class="level4" data-number="4.10.6.8">
<h4 data-number="4.10.6.8" class="anchored" data-anchor-id="use-llms-as-a-collaborative-partner"><span class="header-section-number">4.10.6.8</span> Use LLMs as a Collaborative Partner</h4>
<p>Rather than relying on the LLM to provide all the answers, think of it as a <strong>collaborative partner</strong>:</p>
<ul>
<li>Use it to brainstorm ideas.</li>
<li>Get inspiration for alternative approaches.</li>
<li>Confirm your understanding of a concept.</li>
</ul>
</section>
<section id="example-use-case-in-this-lecture" class="level4" data-number="4.10.6.9">
<h4 data-number="4.10.6.9" class="anchored" data-anchor-id="example-use-case-in-this-lecture"><span class="header-section-number">4.10.6.9</span> Example Use Case in This Lecture</h4>
<p>When developing the binomial lattice model, you might use an LLM in the following ways:</p>
<ul>
<li>Ask it to write a function for constructing the lattice based on specific parameters.</li>
<li>Request help in explaining how the binomial distribution relates to the model.</li>
<li>Seek guidance on how to visualize the lattice effectively with <code>ggplot2</code>.</li>
</ul>
<p>By combining your own problem-solving skills with the capabilities of an LLM, you can streamline the development process while enhancing your learning experience.</p>
</section>
</section>
</section>
<section id="project-portfolio-simulation-and-analysis-with-discrete-random-variables" class="level2" data-number="4.11">
<h2 data-number="4.11" class="anchored" data-anchor-id="project-portfolio-simulation-and-analysis-with-discrete-random-variables"><span class="header-section-number">4.11</span> Project: Portfolio Simulation and Analysis with Discrete Random Variables</h2>
</section>
<section id="project-overview" class="level2" data-number="4.12">
<h2 data-number="4.12" class="anchored" data-anchor-id="project-overview"><span class="header-section-number">4.12</span> Project Overview</h2>
<p>In this project, you will simulate and analyze the performance of a portfolio composed of three assets under uncertain economic conditions. You will model the asset returns using discrete random variables, compute key portfolio metrics like expected return and variance, and understand the economic intuition behind portfolio diversification. This project will also reinforce key programming concepts such as modular functions, control structures, and R’s list structure.</p>
</section>
<section id="project-objectives" class="level2" data-number="4.13">
<h2 data-number="4.13" class="anchored" data-anchor-id="project-objectives"><span class="header-section-number">4.13</span> Project Objectives</h2>
<p>By the end of this project, you should be able to:</p>
<ol type="1">
<li>Apply the concept of random variables to model asset returns under uncertainty.</li>
<li>Simulate portfolio performance over multiple periods.</li>
<li>Compute and interpret key portfolio metrics: expected return, variance, and covariance.</li>
<li>Use modular programming, control structures, and lists in R to build efficient and reusable code.</li>
<li>Understand the trade-offs between risk and return in portfolio theory.</li>
</ol>
<section id="define-the-portfolio" class="level3" data-number="4.13.1">
<h3 data-number="4.13.1" class="anchored" data-anchor-id="define-the-portfolio"><span class="header-section-number">4.13.1</span> Define the Portfolio</h3>
<ol type="1">
<li><p>Define three economic states: <code>"High"</code>, <code>"Medium"</code>, and <code>"Low"</code>, and their probabilities: 30%, 50%, and 20%.</p></li>
<li><p>Assign discrete returns for three assets under each state:</p>
<ul>
<li><p>Asset 1: <code>c(0.08, 0.04, -0.02)</code></p></li>
<li><p>Asset 2: <code>c(0.12, 0.03, -0.05)</code></p></li>
<li><p>Asset 3: <code>c(0.05, 0.02, 0.01)</code></p></li>
</ul></li>
<li><p>Specify portfolio weights: 50% for Asset 1, 30% for Asset 2, and 20% for Asset 3.</p></li>
</ol>
</section>
<section id="simulate-portfolio-performance" class="level3" data-number="4.13.2">
<h3 data-number="4.13.2" class="anchored" data-anchor-id="simulate-portfolio-performance"><span class="header-section-number">4.13.2</span> Simulate Portfolio Performance</h3>
<ol type="1">
<li><p>Write modular functions to:</p>
<ul>
<li><p>Simulate a random economic state based on the given probabilities.</p></li>
<li><p>Retrieve asset returns for the simulated state using a list structure.</p></li>
<li><p>Compute the portfolio return as the weighted sum of asset returns.</p></li>
</ul></li>
<li><p>Simulate portfolio performance over 1,000 periods and store the results in a list. Each element should include:</p>
<ul>
<li><p>The simulated state.</p></li>
<li><p>Returns for each asset.</p></li>
<li><p>The portfolio return.</p></li>
</ul></li>
</ol>
</section>
<section id="analyze-portfolio-performance" class="level3" data-number="4.13.3">
<h3 data-number="4.13.3" class="anchored" data-anchor-id="analyze-portfolio-performance"><span class="header-section-number">4.13.3</span> Analyze Portfolio Performance</h3>
<ol type="1">
<li><p>Compute summary statistics for the simulated portfolio returns:</p>
<ul>
<li><p>Mean return.</p></li>
<li><p>Variance of returns.</p></li>
</ul></li>
<li><p>Compare the simulated mean return with the <strong>theoretical expected portfolio return</strong>, calculated as: <span class="math display">\[
E(R_{\text{portfolio}}) = \sum_{i=1}^n w^i \cdot E(r^i)
\]</span></p></li>
<li><p>(Optional) Compute the theoretical portfolio variance: <span class="math display">\[
\text{Var}(R_{\text{portfolio}}) = \sum_{i=1}^n (w^i)^2 \cdot \text{Var}(r^i) + \sum_{i \neq j} w^i \cdot w^j \cdot \text{Cov}(r^i, r^j)
\]</span></p></li>
</ol>
</section>
<section id="visualize-results" class="level3" data-number="4.13.4">
<h3 data-number="4.13.4" class="anchored" data-anchor-id="visualize-results"><span class="header-section-number">4.13.4</span> Visualize Results</h3>
<ol type="1">
<li>Create a histogram of the simulated portfolio returns.</li>
<li>Calculate and display the frequency of each economic state in the simulation to verify that the probabilities were correctly implemented.</li>
</ol>
</section>
<section id="reflection-and-extensions" class="level3" data-number="4.13.5">
<h3 data-number="4.13.5" class="anchored" data-anchor-id="reflection-and-extensions"><span class="header-section-number">4.13.5</span> Reflection and Extensions</h3>
<ol type="1">
<li><p>Reflect on the relationship between diversification and risk. How does combining assets with different return profiles reduce portfolio variance?</p></li>
<li><p>Add a fourth asset to the portfolio and observe its impact on portfolio metrics. Explore how changing portfolio weights affects expected return and variance.</p></li>
</ol>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-WickhamBryan2023" class="csl-entry" role="listitem">
Wickham, Hadley, and Jenifer Bryan. 2023. <em>R Packages: Organize, Test, Document, and Share Your Code</em>. O’Reilly. <a href="https://r-pkgs.org/">https://r-pkgs.org/</a>.
</div>
</div>
</section>
</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/martin-summer-1090\.github\.io\/Probability_Introduction\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./03-lecture3.html" class="pagination-link" aria-label="Conditional Probability">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Conditional Probability</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./06-references.html" class="pagination-link" aria-label="References">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">References</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>